Since the integration of the backend server (`Server.py`) is the critical step to enable login and cross-platform data saving, I'll provide you with the **full updated JavaScript section** of your `FINAPP3.html` file.

This update replaces all instances of `localStorage` with **API calls** to your deployed Render server and adds the necessary **Login/Account view** functionality.

**Note:** You must replace the placeholder `YOUR_RENDER_URL` with the actual public URL provided by Render (e.g., `https://finplan-app-xyz.onrender.com`).

-----

## 1\. HTML View Update (For `FINAPP3.html` Body)

First, add this new `view-account` container to your HTML, before the Transaction Log view.

```html
<div id="view-account" class="view-container hidden space-y-8">
    <section id="login-form-card" class="bg-white p-6 rounded-2xl shadow-sm max-w-md mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center" id="account-header">Account Login</h2>
        <p class="text-sm text-gray-500 mb-6 text-center">Login to sync your data across all devices, or register a new account.</p>

        <form id="login-form" class="space-y-4">
            <div>
                <label for="auth-username" class="block text-sm font-medium text-gray-700">Username</label>
                <input type="text" id="auth-username" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="auth-password" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-between space-x-2 pt-4">
                <button type="submit" data-action="login" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Login</button>
                <button type="button" id="register-btn" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Register</button>
            </div>
        </form>
        
        <div id="logout-container" class="mt-8 text-center hidden">
             <p id="logged-in-message" class="text-lg font-semibold text-gray-700 mb-4">Logged in as: User</p>
             <button type="button" id="logout-btn" class="w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">Logout</button>
        </div>
    </section>
</div>
```

## 2\. HTML Navigation Update

Update your fixed bottom navigation bar (`#bottom-nav`) to include the new "Account" button.

```html
<button data-view="calendar" data-name="Calendar" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0 active-nav">Calendar</button>
<button data-view="log" data-name="Transaction Log" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Log</button>

<button data-view="account" data-name="Account" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Account</button>
```

-----

## 3\. Full Updated JavaScript (`<script type="module">` Content)

**Replace the entire content** of your existing `<script type="module">` tag with the following code. This includes the new server logic, authentication functions, and API calls.

```javascript
import { addMonths, eachDayOfInterval, format, getDay, getDate, endOfMonth, startOfMonth, startOfWeek, endOfWeek, addDays, isSameMonth, isToday, subMonths, parseISO, subDays, getISOWeek, startOfWeek as startOfISOWeek, endOfWeek as endOfISOWeek, isBefore, isSameDay } from 'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/esm/index.js';

// =========================================================================
// 0. CRITICAL CONFIGURATION
// =========================================================================
// !!! REPLACE THIS WITH YOUR RENDER PUBLIC URL !!!
// e.g., const RENDER_URL = "https://finplan-app-xyz.onrender.com";
const RENDER_URL = "YOUR_RENDER_URL"; 
// =========================================================================

// =========================================================================
// DOM ACCESS HELPERS 
// =========================================================================
function getUserStatusEl() { return document.getElementById('user-status'); }
function getPageTitleEl() { return document.getElementById('page-title'); }

let startDateEl, projectionMonthsEl, startingBalanceEl, startDateDashboardEl, projectionMonthsDashboardEl, startingBalanceDashboardEl;
let schedulesListEl, debtPlansListEl, transactionFilterEl, statusMessageEl, manualSaveBtn, manualSaveBtnDashboard, planButtonsEl;
let scheduleModal, oneTimeModal, debtPlanModal, dayDetailsModal;
let scheduleForm, oneTimeForm, debtPlanForm;
let scheduleIdInput, frequencySelect, debtIdInput;
let navButtons, viewContainers, calendarGridEl, calendarSizeButtons;

// NEW ELEMENTS FOR PLAN VIEW
let savingsSliderEl, savedAmountDisplayEl, remainingBudgetBaseEl, categoryTogglesEl, deletePlanBtnEl;
let toggleEODBalanceEl; // NEW ELEMENT
// AUTH ELEMENTS
let authUsernameEl, authPasswordEl, loginFormEl, registerBtnEl, logoutBtnEl, logoutContainerEl, loggedInMessageEl;


function initDomElements() {
    startDateEl = document.getElementById('startDate');
    projectionMonthsEl = document.getElementById('projectionMonths');
    startingBalanceEl = document.getElementById('startingBalance');
    startDateDashboardEl = document.getElementById('startDate_dashboard');
    projectionMonthsDashboardEl = document.getElementById('projectionMonths_dashboard');
    startingBalanceDashboardEl = document.getElementById('startingBalance_dashboard');
    schedulesListEl = document.getElementById('schedulesList');
    debtPlansListEl = document.getElementById('debtPlansList');
    transactionFilterEl = document.getElementById('transactionFilter');
    statusMessageEl = document.getElementById('status-message'); 
    manualSaveBtn = document.getElementById('manual-save-btn'); 
    manualSaveBtnDashboard = document.getElementById('manual-save-btn-dashboard');
    planButtonsEl = document.getElementById('plan-buttons'); 

    scheduleModal = document.getElementById('schedule-modal');
    oneTimeModal = document.getElementById('onetime-modal');
    debtPlanModal = document.getElementById('debt-plan-modal'); 
    dayDetailsModal = document.getElementById('day-details-modal'); 

    scheduleForm = document.getElementById('schedule-form');
    oneTimeForm = document.getElementById('onetime-form');
    debtPlanForm = document.getElementById('debt-plan-form'); 

    scheduleIdInput = document.getElementById('schedule-id');
    frequencySelect = document.getElementById('frequency');
    debtIdInput = document.getElementById('debt-id'); 
    
    navButtons = document.querySelectorAll('.nav-btn');
    viewContainers = document.querySelectorAll('.view-container');
    calendarGridEl = document.getElementById('calendar-grid');
    calendarSizeButtons = document.querySelectorAll('.calendar-size-btn');
    
    // NEW ELEMENTS FOR PLAN VIEW
    savingsSliderEl = document.getElementById('savings-slider');
    savedAmountDisplayEl = document.getElementById('saved-amount-display');
    remainingBudgetBaseEl = document.getElementById('remaining-budget-base');
    categoryTogglesEl = document.getElementById('category-toggles');
    deletePlanBtnEl = document.getElementById('delete-plan-btn'); 
    toggleEODBalanceEl = document.getElementById('toggleEODBalance');
    
    // NEW AUTH ELEMENTS
    authUsernameEl = document.getElementById('auth-username');
    authPasswordEl = document.getElementById('auth-password');
    loginFormEl = document.getElementById('login-form');
    registerBtnEl = document.getElementById('register-btn');
    logoutBtnEl = document.getElementById('logout-btn');
    logoutContainerEl = document.getElementById('logout-container');
    loggedInMessageEl = document.getElementById('logged-in-message');
}
// =========================================================================


document.addEventListener('DOMContentLoaded', async () => {
    
    initDomElements();

    // =========================================================================
    // 1. CORE APPLICATION VARIABLES (NO LONGER SYNCED DIRECTLY TO localStorage)
    // =========================================================================
    let recurringSchedules = [];
    let oneTimeTransactions = [];
    let debtPlans = []; 
    let currentCalendarDate = new Date();
    let activeView = 'calendar'; 
    let dailyTransactionMap = {}; 
    let dailyBalanceMap = {}; 
    
    let savedAmount = 0; 
    let showEODBalance = false; // Default off, loaded from user_data
    let isLoggedIn = false;
    let currentUsername = 'Local User';
    
    // Default/Fallback Settings
    const DEFAULT_STARTING_BALANCE = 5000;
    const DEFAULT_PROJECTION_MONTHS = 12;
    
    const defaultSchedules = [
        { id: 'RENT-01', name: 'Monthly Rent Payment', amount: -1010.00, startDate: '2024-01-03', frequency: 'Monthly', dayValue: 3, enabled: true },
        { id: 'SALARY-01', name: 'Weekly Salary', amount: 1000.00, startDate: '2024-01-04', frequency: 'Weekly', dayValue: 'Thursday', enabled: true },
    ];
    
    const weeklyDayMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
    
    let cashFlowChart, monthlyNetChart;
    
    const calendarSizes = { 'small': '320px', 'medium': '450px', 'large': '600px' };
    let currentCalendarSize = 'large'; 
    
    const SPENDING_CATEGORIES = [
        { name: 'Groceries', percentage: 40, fixedWeeklyAmount: 0, defaultEnabled: true },
        { name: 'Gas/Fuel', percentage: 30, fixedWeeklyAmount: 0, defaultEnabled: true },
        { name: 'Misc. Spending', percentage: 30, fixedWeeklyAmount: 0, defaultEnabled: true },
        { name: 'Transportation', percentage: 0, fixedWeeklyAmount: 50.00, defaultEnabled: false } 
    ];
    let activeSpendingCategories = []; 
    
    // --- APP STARTUP ---
    await showDashboard();

    // =========================================================================
    // 2. AUTHENTICATION & DATA SYNCHRONIZATION (NEW)
    // =========================================================================
    
    async function checkAuthStatus() {
        if (RENDER_URL === "YOUR_RENDER_URL") {
            getUserStatusEl().textContent = `Status: Local Mode (RENDER_URL not set)`;
            isLoggedIn = false;
            currentUsername = 'Local User';
            return { logged_in: false };
        }
        
        try {
            const response = await fetch(`${RENDER_URL}/api/auth/status`);
            const data = await response.json();
            
            isLoggedIn = data.logged_in;
            currentUsername = data.username || 'Local User';

            if (isLoggedIn) {
                getUserStatusEl().textContent = `Status: Synced (Logged in as ${currentUsername})`;
                setAccountViewState(true);
            } else {
                getUserStatusEl().textContent = `Status: Logged Out`;
                setAccountViewState(false);
            }
            return data;
        } catch (e) {
            console.error("Authentication check failed. Server likely down.", e);
            getUserStatusEl().textContent = `Status: OFFLINE (Server connection failed)`;
            isLoggedIn = false;
            setAccountViewState(false);
            return { logged_in: false };
        }
    }
    
    function setAccountViewState(loggedIn) {
        if (loggedIn) {
            loginFormEl.classList.add('hidden');
            logoutContainerEl.classList.remove('hidden');
            loggedInMessageEl.textContent = `Logged in as: ${currentUsername}`;
        } else {
            loginFormEl.classList.remove('hidden');
            logoutContainerEl.classList.add('hidden');
            document.getElementById('account-header').textContent = 'Account Login';
        }
    }

    async function handleAuth(action) {
        const username = authUsernameEl.value;
        const password = authPasswordEl.value;
        
        if (!username || !password) {
            showStatus('Username and password are required.', 'bg-red-100 text-red-700');
            return;
        }

        const endpoint = action === 'login' ? '/api/auth/login' : '/api/auth/register';
        
        try {
            const response = await fetch(`${RENDER_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (data.success) {
                showStatus(`${data.message}. Redirecting to Calendar.`, 'bg-green-100 text-green-700');
                // Re-run the full startup sequence to load data and switch views
                await checkAuthStatus();
                await loadData(); // Load the fresh data (or defaults for new users)
                updateDashboard();
                changeView('calendar');
            } else {
                showStatus(`Authentication Failed: ${data.message}`, 'bg-red-100 text-red-700');
            }
        } catch (e) {
            showStatus('Server connection error. Please try again.', 'bg-red-100 text-red-700');
        }
    }
    
    async function handleLogout() {
        try {
            await fetch(`${RENDER_URL}/api/auth/logout`);
            isLoggedIn = false;
            currentUsername = 'Local User';
            showStatus('Logged out successfully. Data is now local (unsaved).', 'bg-blue-100 text-blue-700');
            
            // Revert app to a clean state
            await loadData(); // Load local defaults 
            updateDashboard();
            setAccountViewState(false);
            getUserStatusEl().textContent = `Status: Logged Out`;
            changeView('account');
            
        } catch (e) {
             showStatus('Logout failed, but connection closed.', 'bg-yellow-100 text-yellow-700');
             setAccountViewState(false);
        }
    }
    
    // --- API LOAD DATA (Replaces localStorage load) ---
    async function loadData() {
        // If not logged in, revert to hardcoded defaults (lost data)
        if (!isLoggedIn) {
            showStatus('Loading default settings. Your previous data is not saved.', 'bg-red-100 text-red-700');
            recurringSchedules = defaultSchedules;
            oneTimeTransactions = [];
            debtPlans = [];
            activeSpendingCategories = SPENDING_CATEGORIES.map(c => ({...c, enabled: c.defaultEnabled}));
            
            // Set defaults to inputs
            startDateEl.value = format(new Date(), 'yyyy-MM-dd');
            projectionMonthsEl.value = DEFAULT_PROJECTION_MONTHS;
            startingBalanceEl.value = DEFAULT_STARTING_BALANCE;
            showEODBalance = false;
            savedAmount = 0;
            currentCalendarSize = 'large';

            return;
        }

        // --- Logged In: Load from API ---
        try {
            const response = await fetch(`${RENDER_URL}/api/load-data`);
            const data = await response.json();
            
            // 1. Load Data Arrays
            recurringSchedules = data.recurringSchedules || defaultSchedules;
            oneTimeTransactions = data.oneTimeTransactions || [];
            debtPlans = data.debtPlans || [];       
            
            // 2. Load Settings (Use defaults if settings key is empty)
            const settings = data.settings || {};
            
            startDateEl.value = settings.startDate || format(new Date(), 'yyyy-MM-dd');
            projectionMonthsEl.value = settings.projectionMonths || DEFAULT_PROJECTION_MONTHS;
            startingBalanceEl.value = settings.startingBalance || DEFAULT_STARTING_BALANCE;

            showEODBalance = settings.showEODBalance === true; // explicitly check for true
            savedAmount = parseFloat(settings.savedAmount) || 0;
            currentCalendarSize = settings.calendarSize || 'large';
            
            // 3. Load Categories
            activeSpendingCategories = settings.activeSpendingCategories || SPENDING_CATEGORIES.map(c => ({...c, enabled: c.defaultEnabled}));

            // Sync all fields and state
            if (toggleEODBalanceEl) toggleEODBalanceEl.checked = showEODBalance;
            setCalendarSize(currentCalendarSize); 
            syncProjectionInputs();
            
            showStatus('Data loaded and synchronized with the cloud.', 'bg-blue-100 text-blue-700');
            
        } catch (e) {
            console.error("Error loading data from API:", e);
            showStatus('ERROR: Failed to load data from server. Check connection.', 'bg-red-100 text-red-700');
        }
    }

    // --- API SAVE DATA (Replaces localStorage save) ---
    function saveData() {
        if (!isLoggedIn) {
            showStatus('Cannot save: You are not logged in. Data will be lost upon refresh.', 'bg-red-100 text-red-700');
            return;
        }
        
        // Compile all state into a single object
        const dataToSave = {
            recurringSchedules: recurringSchedules,
            oneTimeTransactions: oneTimeTransactions,
            debtPlans: debtPlans,
            
            settings: {
                startingBalance: startingBalanceEl.value,
                projectionMonths: projectionMonthsEl.value,
                startDate: startDateEl.value,
                showEODBalance: showEODBalance,
                savedAmount: savedAmount.toFixed(2),
                calendarSize: currentCalendarSize,
                activeSpendingCategories: activeSpendingCategories
            }
        };

        fetch(`${RENDER_URL}/api/save-data`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSave)
        })
        .then(response => {
            if (response.ok) {
                showStatus('Settings and Data saved successfully to cloud!', 'bg-blue-100 text-blue-700');
            } else {
                 // Check if we got a 401 Unauthorized
                if (response.status === 401) {
                    showStatus('ERROR: Save failed - Unauthorized. Please log in again.', 'bg-red-100 text-red-700');
                    isLoggedIn = false; 
                    setAccountViewState(false); 
                    changeView('account');
                } else {
                    return response.json().then(err => { throw new Error(err.message || 'Server error'); });
                }
            }
        })
        .catch(e => {
            console.error("Error saving data to API:", e);
            showStatus(`ERROR: Save failed - ${e.message}`, 'bg-red-100 text-red-700');
        });
    }

    // --- SYNCHRONIZE PROJECTION INPUTS ---
    function syncProjectionInputs() {
        const balance = startingBalanceEl.value;
        const months = projectionMonthsEl.value;
        const date = startDateEl.value;

        if (startingBalanceDashboardEl) startingBalanceDashboardEl.value = balance;
        if (projectionMonthsDashboardEl) projectionMonthsDashboardEl.value = months;
        if (startDateDashboardEl) startDateDashboardEl.value = date;
    }
    
    // =========================================================================
    // 3. EVENT LISTENERS AND UTILITIES
    // (Most functions remain the same, but the 'saveAndRender' call is crucial)
    // =========================================================================

    function saveAndRender() {
        saveData(); // Now calls the API save
        renderSchedules();
        renderDebtPlans(); 
        updateDashboard();
    }
    
    // Displays a temporary status message
    function showStatus(message, colorClass) {
        if (statusMessageEl) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `fixed top-0 left-0 right-0 p-3 text-center text-sm font-medium transition duration-300 ${colorClass} shadow-lg`;
            statusMessageEl.classList.remove('opacity-0');
            statusMessageEl.classList.add('opacity-100');
            setTimeout(() => {
                statusMessageEl.classList.remove('opacity-100');
                statusMessageEl.classList.add('opacity-0');
            }, 5000);
        }
    }

    function setCalendarSize(size) {
        if (calendarSizes[size]) {
            currentCalendarSize = size;
            calendarGridEl.style.minWidth = calendarSizes[size];
            
            calendarGridEl.classList.remove('calendar-day-text-sm', 'calendar-day-text-medium');
            if (size === 'small') {
                calendarGridEl.classList.add('calendar-day-text-sm');
            } else if (size === 'medium') {
                calendarGridEl.classList.add('calendar-day-text-medium');
            }

            calendarSizeButtons.forEach(btn => {
                const isSelected = btn.dataset.size === size;
                btn.classList.toggle('bg-blue-600', isSelected);
                btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('bg-gray-200', !isSelected);
                btn.classList.toggle('text-gray-800', !isSelected);
            });
        }
    }
    
    function setToggleVisuals(containerId, type) {
        const toggleContainer = document.getElementById(containerId);
        const expenseBtn = toggleContainer.querySelector('[data-type="expense"]');
        const incomeBtn = toggleContainer.querySelector('[data-type="income"]');

        if (type === 'income') {
            incomeBtn.classList.remove('bg-white', 'text-gray-700', 'border-l');
            incomeBtn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            expenseBtn.classList.remove('bg-red-100', 'text-red-700');
            expenseBtn.classList.add('bg-white', 'text-gray-700');
            incomeBtn.dataset.current = 'income';
            expenseBtn.dataset.current = '';
        } else { // default to expense
            expenseBtn.classList.remove('bg-white', 'text-gray-700');
            expenseBtn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            incomeBtn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
            incomeBtn.classList.add('bg-white', 'text-gray-700', 'border-l');
            expenseBtn.dataset.current = 'expense';
            incomeBtn.dataset.current = '';
        }
    }

    function changeView(viewId) {
        activeView = viewId;
        viewContainers.forEach(container => {
            container.classList.add('hidden');
        });
        document.getElementById(`view-${viewId}`).classList.remove('hidden');

        const activeNavButton = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
        if (activeNavButton) {
            getPageTitleEl().textContent = activeNavButton.dataset.name;
        }

        navButtons.forEach(btn => {
            btn.classList.remove('active-nav');
            if (btn.dataset.view === viewId) {
                btn.classList.add('active-nav');
            }
        });
        
        if (viewId === 'dashboard') {
            setTimeout(() => {
                updateCashFlowChart(generateProjections());
                updateMonthlyNetChart(generateProjections());
            }, 10); 
        } else if (viewId === 'plan') {
            const projections = generateProjections();
            const metrics = updateKeyMetrics(projections);
            generateSpendingPlans(metrics); 
        }
    }

    function renderDebtPlans() {
        debtPlansListEl.innerHTML = '';
        debtPlans.forEach(plan => {
            const monthly = (plan.totalAmount / plan.payoffMonths).toFixed(2);
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 rounded-xl border border-pink-200 bg-white shadow-sm hover:shadow-md transition';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mr-4 bg-pink-500"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${plan.name}</p>
                        <p class="text-sm text-gray-500">Total: $${plan.totalAmount.toLocaleString()} | Payoff: ${plan.payoffMonths} months</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p class="font-bold text-lg text-pink-600 w-24 text-right">
                        $${monthly}
                    </p>
                    <div class="flex space-x-1">
                        <button type="button" class="debt-edit-btn p-2 text-gray-500 hover:text-pink-600 rounded-full hover:bg-gray-100" data-id="${plan.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="debt-delete-btn p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100" data-id="${plan.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            debtPlansListEl.appendChild(item);
        });
    }

    function renderSchedules() {
        schedulesListEl.innerHTML = '';
        recurringSchedules.forEach(schedule => {
            const isExpense = schedule.amount < 0;
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 rounded-xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mr-4 ${isExpense ? 'bg-red-500' : 'bg-green-500'}"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${schedule.name}</p>
                        <p class="text-sm text-gray-500">${isExpense ? 'Expense' : 'Income'}: ${schedule.frequency}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p class="font-semibold text-lg ${isExpense ? 'text-red-600' : 'text-green-600'} w-24 text-right">
                        $${Math.abs(schedule.amount).toFixed(2)}
                    </p>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" name="toggle" id="toggle-${schedule.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${schedule.enabled ? 'checked' : ''} data-id="${schedule.id}"/>
                        <label for="toggle-${schedule.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <div class="flex space-x-1">
                        <button type="button" class="edit-btn p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100" data-id="${schedule.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="delete-btn p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100" data-id="${schedule.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            schedulesListEl.appendChild(item);
        });
    }

    function addEventListeners() {
        // AUTH LISTENERS (NEW)
        loginFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuth('login');
        });
        registerBtnEl.addEventListener('click', () => {
             handleAuth('register');
        });
        logoutBtnEl.addEventListener('click', handleLogout);
        
        // Navigation Listener
        navButtons.forEach(btn => btn.addEventListener('click', (e) => {
            changeView(e.currentTarget.dataset.view);
        }));
        
        // Listener for calendar size buttons
        calendarSizeButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                setCalendarSize(e.target.dataset.size);
                updateDashboard();
            });
        });

        // NOTE: All handlers call updateDashboard, which calls saveAndRender, which calls saveData.
        
        // Sync inputs and trigger dashboard update/save
        [startDateEl, projectionMonthsEl, startingBalanceEl].forEach(el => el.addEventListener('change', (e) => {
            syncProjectionInputs();
            updateDashboard();
        }));
        
        // Sync inputs from dashboard controls to calendar fields
        [startDateDashboardEl, projectionMonthsDashboardEl, startingBalanceDashboardEl].forEach(el => el.addEventListener('change', (e) => {
            startDateEl.value = startDateDashboardEl.value;
            projectionMonthsEl.value = projectionMonthsDashboardEl.value;
            startingBalanceEl.value = startingBalanceDashboardEl.value;
            syncProjectionInputs();
            updateDashboard();
        }));
        
        // Manual Save Button Listener (Calendar & Dashboard versions)
        manualSaveBtn.addEventListener('click', updateDashboard);
        document.getElementById('manual-save-btn-dashboard').addEventListener('click', updateDashboard);
        
        // Listeners for type toggles (One-Time)
        document.getElementById('onetime-type-toggle').addEventListener('click', (e) => {
            if (e.target.dataset.type) {
                setToggleVisuals('onetime-type-toggle', e.target.dataset.type);
            }
        });

        // Listeners for type toggles (Recurring)
        document.getElementById('schedule-type-toggle').addEventListener('click', (e) => {
            if (e.target.dataset.type) {
                setToggleVisuals('schedule-type-toggle', e.target.dataset.type);
            }
        });
        
        // --- DEBT PLAN EVENT LISTENERS ---
        debtPlansListEl.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.debt-edit-btn');
            const deleteBtn = e.target.closest('.debt-delete-btn');

            if (editBtn) {
                openDebtPlanModal(debtPlans.find(p => p.id === editBtn.dataset.id));
            } else if (deleteBtn) {
                if(confirm('Are you sure you want to delete this debt plan?')) {
                    debtPlans = debtPlans.filter(p => p.id !== deleteBtn.dataset.id);
                    saveAndRender();
                }
            }
        });

        document.getElementById('add-debt-plan-btn').addEventListener('click', () => openDebtPlanModal());
        document.querySelector('.cancel-btn-debt').addEventListener('click', () => closeModal(debtPlanModal));

        debtPlanForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = debtIdInput.value;
            const totalAmount = parseFloat(document.getElementById('total-amount').value);
            const payoffMonths = parseInt(document.getElementById('payoff-months').value);
            
            const newDebtPlan = {
                id: id || `DEBT-${Date.now()}`,
                name: document.getElementById('debt-name').value,
                totalAmount: totalAmount,
                payoffMonths: payoffMonths,
                monthlyPayment: parseFloat((totalAmount / payoffMonths).toFixed(2)),
                payDay: parseInt(format(parseISO(document.getElementById('debt-start-date').value), 'd')),
                startDate: document.getElementById('debt-start-date').value,
                enabled: true
            };

            if (id) {
                const index = debtPlans.findIndex(p => p.id === id);
                debtPlans[index] = newDebtPlan;
            } else {
                debtPlans.push(newDebtPlan);
            }
            closeModal(debtPlanModal);
            saveAndRender();
        });
        // --- END DEBT PLAN EVENT LISTENERS ---

        // Recurring Schedule Event Listeners
        schedulesListEl.addEventListener('click', (e) => {
            const toggle = e.target.closest('.toggle-checkbox');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (toggle) {
                const schedule = recurringSchedules.find(s => s.id === toggle.dataset.id);
                if (schedule) {
                    schedule.enabled = toggle.checked;
                    saveAndRender();
                }
            } else if (editBtn) {
                openRecurringModal(recurringSchedules.find(s => s.id === editBtn.dataset.id));
            } else if (deleteBtn) {
                if(confirm('Are you sure you want to delete this recurring schedule?')) {
                    recurringSchedules = recurringSchedules.filter(s => s.id !== deleteBtn.dataset.id);
                    saveAndRender();
                }
            }
        });

        document.getElementById('add-schedule-btn').addEventListener('click', () => openRecurringModal());
        document.getElementById('add-one-time-btn').addEventListener('click', () => openOneTimeModal());
        
        // Cancel buttons for all modals
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => {
            closeModal(scheduleModal);
            closeModal(oneTimeModal);
        }));
        document.getElementById('close-day-details-btn').addEventListener('click', () => closeModal(dayDetailsModal));

        // MODAL ADD ONE-TIME EVENT LISTENER
        document.getElementById('add-from-day-details').addEventListener('click', (e) => {
            const dateKey = e.currentTarget.dataset.date;
            closeModal(dayDetailsModal);
            openOneTimeModal(null, dateKey); 
        });

        // Modal close on backdrop click
        scheduleModal.addEventListener('click', (e) => { if (e.target === scheduleModal) closeModal(scheduleModal); });
        oneTimeModal.addEventListener('click', (e) => { if (e.target === oneTimeModal) closeModal(oneTimeModal); });
        debtPlanModal.addEventListener('click', (e) => { if (e.target === debtPlanModal) closeModal(debtPlanModal); }); 
        dayDetailsModal.addEventListener('click', (e) => { if (e.target === dayDetailsModal) closeModal(dayDetailsModal); }); 
        
        // Spending Plan: Apply Plan
        planButtonsEl.addEventListener('click', (e) => {
            const button = e.target.closest('.apply-plan-btn');
            if (button) {
                const planData = JSON.parse(button.dataset.plan);
                applySpendingPlan(planData);
            }
        });

        // Submit Recurring Schedule
        scheduleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = scheduleIdInput.value;
            const rawAmount = parseFloat(document.getElementById('amount').value);
            const isIncome = document.querySelector('#schedule-type-toggle [data-current="income"]');
            const finalAmount = isIncome ? rawAmount : -rawAmount; // Apply sign based on toggle

            const newSchedule = {
                id: id || `SCH-${Date.now()}`,
                name: document.getElementById('name').value,
                amount: finalAmount, // Use signed amount
                startDate: document.getElementById('start_date').value,
                frequency: frequencySelect.value,
                dayValue: frequencySelect.value === 'Monthly' ? parseInt(document.getElementById('day_value_month').value) : document.getElementById('day_value_week').value,
                enabled: true
            };

            if (id) {
                const index = recurringSchedules.findIndex(s => s.id === id);
                newSchedule.enabled = recurringSchedules[index].enabled;
                recurringSchedules[index] = newSchedule;
            } else {
                recurringSchedules.push(newSchedule);
            }
            closeModal(scheduleModal);
            saveAndRender();
        });

        // Submit One-Time Transaction (UPDATED TO HANDLE EDITING)
        oneTimeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('onetime-id').value; // Get ID for editing
            const rawAmount = parseFloat(document.getElementById('onetime-amount').value);
            const isIncome = document.querySelector('#onetime-type-toggle [data-current="income"]');
            const finalAmount = isIncome ? rawAmount : -rawAmount; // Apply sign based on toggle
            
            const newTransaction = {
                id: id || `ONE-${Date.now()}`,
                name: document.getElementById('onetime-name').value,
                amount: finalAmount, // Use signed amount
                date: document.getElementById('onetime-date').value,
            };

            if (id) {
                const index = oneTimeTransactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    oneTimeTransactions[index] = newTransaction;
                }
            } else {
                oneTimeTransactions.push(newTransaction);
            }
            
            closeModal(oneTimeModal);
            saveAndRender();
        });

        frequencySelect.addEventListener('change', toggleDayValueInputs);

        document.getElementById('prev-month').addEventListener('click', () => {
            currentCalendarDate = subMonths(currentCalendarDate, 1);
            updateDashboard(); 
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentCalendarDate = addMonths(currentCalendarDate, 1);
            updateDashboard(); 
        });
        
        // Listener for clicking on calendar days
        document.getElementById('calendar-grid').addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl && dayEl.dataset.date) {
                openDayDetailsModal(dayEl.dataset.date);
            }
        });
        
        // Listener for buttons within the Day Details Modal
        document.getElementById('day-details-list').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-onetime-btn');
            const editBtn = e.target.closest('.edit-onetime-btn');
            
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const transactionToDelete = oneTimeTransactions.find(t => t.id === id);

                if (transactionToDelete && confirm(`Are you sure you want to delete the one-time event: "${transactionToDelete.name}"?`)) {
                    oneTimeTransactions = oneTimeTransactions.filter(t => t.id !== id);
                    closeModal(dayDetailsModal);
                    saveAndRender();
                } else if (!transactionToDelete) {
                     console.error(`Attempted to delete one-time transaction with ID ${id}, but it was not found.`);
                }
            } else if (editBtn) {
                const id = editBtn.dataset.id;
                const transactionToEdit = oneTimeTransactions.find(t => t.id === id);
                if (transactionToEdit) {
                    closeModal(dayDetailsModal);
                    openOneTimeModal(transactionToEdit);
                }
            }
        });
        
        // Savings Slider Listener
        savingsSliderEl.addEventListener('input', (e) => {
            savedAmount = parseFloat(e.target.value);
            const max = parseFloat(savingsSliderEl.max);
            const percentage = (max > 0) ? (savedAmount / max) * 100 : 0;
            savingsSliderEl.style.setProperty('--slider-progress', `${percentage}%`);
            savedAmountDisplayEl.textContent = `$${savedAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            updateDashboard();
        });
        
        // Delete Plan Listener
        deletePlanBtnEl.addEventListener('click', () => {
            if (confirm('Are you sure you want to DELETE the current spending plan (all transactions tagged "(Planned)")?')) {
                oneTimeTransactions = oneTimeTransactions.filter(t => !t.name.includes('(Planned)'));
                showStatus('All planned spending transactions deleted.', 'bg-red-100 text-red-700');
                saveAndRender();
            }
        });
        
        // Category Toggle Listener
        categoryTogglesEl.addEventListener('click', (e) => {
            const toggle = e.target.closest('input[type="checkbox"]');
            if (toggle) {
                const categoryName = toggle.dataset.category;
                const isChecked = toggle.checked;

                const categoryIndex = activeSpendingCategories.findIndex(c => c.name === categoryName);
                if (categoryIndex !== -1) {
                    activeSpendingCategories[categoryIndex].enabled = isChecked;
                    updateDashboard();
                }
            }
        });
        
        // EOD Balance Toggle Listener
        if (toggleEODBalanceEl) {
            toggleEODBalanceEl.addEventListener('change', (e) => {
                showEODBalance = e.target.checked;
                updateDashboard();
            });
        }
    }
    
    function openRecurringModal(schedule = null) {
        // ... (Modal logic remains the same, ensure to call saveAndRender on submit)
        scheduleForm.reset();
        let type = 'expense';
        let amountValue = '';

        if (schedule) {
            document.getElementById('modal-title').textContent = 'Edit Recurring Schedule';
            scheduleIdInput.value = schedule.id;
            document.getElementById('name').value = schedule.name;
            
            amountValue = Math.abs(schedule.amount);
            type = schedule.amount > 0 ? 'income' : 'expense';

            document.getElementById('start_date').value = schedule.startDate;
            frequencySelect.value = schedule.frequency;
            if (document.getElementById('day_value_month')) document.getElementById('day_value_month').value = schedule.dayValue;
            if (document.getElementById('day_value_week')) document.getElementById('day_value_week').value = schedule.dayValue;
        } else {
            document.getElementById('modal-title').textContent = 'Add New Recurring Schedule';
            scheduleIdInput.value = '';
        }
        
        document.getElementById('amount').value = amountValue || '';
        setToggleVisuals('schedule-type-toggle', type);
        toggleDayValueInputs();
        scheduleModal.classList.remove('modal-inactive');
        scheduleModal.classList.add('modal-active');
    }

    function openOneTimeModal(transaction = null, dateKey = null) { 
        // ... (Modal logic remains the same, ensure to call saveAndRender on submit)
        oneTimeForm.reset();
        document.getElementById('onetime-id').value = ''; 
        let type = 'expense';
        let amountValue = '';
        let dateToSet = dateKey || format(currentCalendarDate, 'yyyy-MM-dd'); 

        if (transaction) {
            document.getElementById('onetime-id').value = transaction.id;
            document.getElementById('onetime-name').value = transaction.name;
            amountValue = Math.abs(transaction.amount);
            type = transaction.amount > 0 ? 'income' : 'expense';
            dateToSet = format(parseISO(transaction.date), 'yyyy-MM-dd'); 
        }
        
        document.getElementById('onetime-date').value = dateToSet;
        document.getElementById('onetime-amount').value = amountValue || '';
        setToggleVisuals('onetime-type-toggle', type);
        oneTimeModal.classList.remove('modal-inactive');
        oneTimeModal.classList.add('modal-active');
    }

    function openDebtPlanModal(plan = null) {
        // ... (Modal logic remains the same, ensure to call saveAndRender on submit)
        debtPlanForm.reset();
        document.getElementById('debt-pay-day').value = 1; 
        if (plan) {
            document.getElementById('debt-modal-title').textContent = 'Edit Debt Plan';
            debtIdInput.value = plan.id;
            document.getElementById('debt-name').value = plan.name;
            document.getElementById('total-amount').value = plan.totalAmount;
            document.getElementById('payoff-months').value = plan.payoffMonths;
            document.getElementById('debt-start-date').value = plan.startDate;
            document.getElementById('debt-pay-day').value = plan.payDay;
        } else {
            document.getElementById('debt-modal-title').textContent = 'Add New Debt Plan';
            debtIdInput.value = '';
            document.getElementById('debt-start-date').value = format(new Date(), 'yyyy-MM-dd');
        }
        debtPlanModal.classList.remove('modal-inactive');
        debtPlanModal.classList.add('modal-active');
    }
    
    function closeModal(el) {
        el.classList.add('modal-inactive');
        el.classList.remove('modal-active');
    }

    function toggleDayValueInputs() {
        if (frequencySelect.value === 'Monthly') {
            document.getElementById('day-value-monthly').classList.remove('hidden');
            document.getElementById('day-value-weekly').classList.add('hidden');
            document.getElementById('day_value_month').required = true;
            document.getElementById('day_value_week').required = false;
        } else if (frequencySelect.value === 'Weekly' || frequencySelect.value === 'BiWeekly') {
            document.getElementById('day-value-monthly').classList.add('hidden');
            document.getElementById('day-value-weekly').classList.remove('hidden');
            document.getElementById('day_value_month').required = false;
            document.getElementById('day_value_week').required = true;
        } else {
             document.getElementById('day-value-monthly').classList.add('hidden');
             document.getElementById('day-value-weekly').classList.add('hidden');
             document.getElementById('day_value_month').required = false;
             document.getElementById('day_value_week').required = false;
        }
    }
    
    function getEndOfDayBalance(dateKey) {
        const startingBalance = parseFloat(startingBalanceEl.value) || 0;
        
        if (dailyBalanceMap[dateKey] !== undefined) {
            return dailyBalanceMap[dateKey];
        }

        let currentDate = parseISO(dateKey);
        const projectionStartDate = parseISO(startDateEl.value);

        let lookBackDate = subDays(currentDate, 1);
        
        while (lookBackDate >= projectionStartDate) {
            const lookBackKey = format(lookBackDate, 'yyyy-MM-dd');
            if (dailyBalanceMap[lookBackKey] !== undefined) {
                return dailyBalanceMap[lookBackKey];
            }
            lookBackDate = subDays(lookBackDate, 1);
        }

        return startingBalance;
    }

    function openDayDetailsModal(dateKey) {
        const transactions = dailyTransactionMap[dateKey] || [];
        const rawFinalBalance = getEndOfDayBalance(dateKey); 
        const finalBalanceText = `$${rawFinalBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
        const titleEl = document.getElementById('day-details-title');
        const listEl = document.getElementById('day-details-list');
        const addOneTimeBtn = document.getElementById('add-from-day-details');

        titleEl.innerHTML = `Transactions on ${format(parseISO(dateKey), 'EEEE, MMM do')}
                             <span class="block text-base font-medium text-gray-600 mt-1">End of Day Balance: <span class="font-bold text-lg text-blue-600">${finalBalanceText}</span></span>`;
        listEl.innerHTML = '';
        
        if (transactions.length === 0) {
             listEl.innerHTML = `<p class="text-center text-gray-500 italic">No scheduled transactions for this day.</p>`;
        }
        
        transactions.forEach(t => {
            const isExpense = t.amount < 0;
            let colorClass = isExpense ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800';
            let amountClass = isExpense ? 'text-red-600' : 'text-green-600';
            let icon = isExpense ? '' : '';
            let typeLabel = t.type === 'Debt Payment' ? 'Debt' : t.type === 'One-Time' ? 'One-Time' : 'Recurring';
            
            const item = document.createElement('div');
            item.className = `flex justify-between items-center p-3 rounded-lg border ${colorClass}`;
            
            let controlsHTML = '';
            if (t.type === 'One-Time') { 
                 controlsHTML = `
                    <div class="flex space-x-2 items-center">
                        <button type="button" class="edit-onetime-btn text-gray-500 hover:text-purple-600 p-1 rounded-full hover:bg-gray-100" data-id="${t.id}" title="Edit Transaction">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="delete-onetime-btn text-gray-500 hover:text-red-600 p-1 rounded-full hover:bg-gray-100" data-id="${t.id}" title="Delete Transaction">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            }

            item.innerHTML = `
                <div class="flex flex-col flex-grow">
                    <span class="font-medium text-gray-800">${t.name}</span>
                    <span class="text-xs text-gray-500">${typeLabel}</span>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="font-bold text-lg ${amountClass}">${icon} $${Math.abs(t.amount).toFixed(2)}</span>
                    ${controlsHTML}
                </div>
            `;
            listEl.appendChild(item);
        });
        
        addOneTimeBtn.dataset.date = dateKey;

        dayDetailsModal.classList.remove('modal-inactive');
        dayDetailsModal.classList.add('modal-active');
    }

    function calculateDailyBalances(projections) {
        let runningBalance = parseFloat(startingBalanceEl.value);
        dailyBalanceMap = {};

        projections.forEach(t => {
            runningBalance += t.amount;
            const dateKey = format(t.date, 'yyyy-MM-dd');
            dailyBalanceMap[dateKey] = runningBalance;
        });
    }


    function generateProjections() {
        const startDate = new Date(startDateEl.value + 'T00:00:00');
        const months = parseInt(projectionMonthsEl.value);
        const endDate = addMonths(startDate, months);
        const activeSchedules = recurringSchedules.filter(s => s.enabled);
        let projections = [];
        
        // 1. Generate Recurring Projections
        const intervalDays = eachDayOfInterval({ start: startDate, end: endDate });
        intervalDays.forEach(day => {
            activeSchedules.forEach(schedule => {
                if (day < new Date(schedule.startDate + 'T00:00:00')) return;

                let shouldPay = false;
                const scheduleStart = parseISO(schedule.startDate);

                if (schedule.frequency === 'Monthly' && getDate(day) === schedule.dayValue) {
                    shouldPay = true;
                } else if (schedule.frequency === 'Weekly' && getDay(day) === weeklyDayMap[schedule.dayValue]) {
                    shouldPay = true;
                } else if (schedule.frequency === 'BiWeekly' && getDay(day) === weeklyDayMap[schedule.dayValue]) {
                    const daysSinceStart = (day.getTime() - scheduleStart.getTime()) / (1000 * 60 * 60 * 24);
                    if (daysSinceStart >= -0.5 && Math.abs(daysSinceStart % 14) < 0.5) { 
                        shouldPay = true;
                    }
                }

                if (shouldPay) {
                    projections.push({ date: day, name: schedule.name, amount: schedule.amount, type: 'Recurring' });
                }
            });
        });

        // 2. Add Debt Plan Payments
        debtPlans.forEach(plan => { 
            let paymentsMade = 0;
            
            let currentMonth = startOfMonth(startDate);
            while (currentMonth <= endDate && paymentsMade < plan.payoffMonths) {
                const day = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), plan.payDay);

                if (day >= startDate && day <= endDate && day >= parseISO(plan.startDate)) {
                    projections.push({ 
                        date: day, 
                        name: `Debt Payment: ${plan.name}`, 
                        amount: -plan.monthlyPayment, 
                        type: 'Debt Payment' 
                    });
                    paymentsMade++;
                }
                currentMonth = addMonths(currentMonth, 1);
            }
        });


        // 3. Add One-Time Transactions
        oneTimeTransactions.forEach(t => {
            const tDate = new Date(t.date + 'T00:00:00');
            if (tDate >= startDate && tDate <= endDate) {
                projections.push({ date: tDate, name: t.name, amount: t.amount, type: 'One-Time', id: t.id });
            }
        });

        return projections.sort((a, b) => a.date - b.date);
    }
    
    function updateDashboard() {
        const projections = generateProjections();
        calculateDailyBalances(projections);
        const metrics = updateKeyMetrics(projections);
        
        syncProjectionInputs();
        
        if (activeView === 'plan' || document.getElementById('view-plan').classList.contains('hidden') === false) {
             generateSpendingPlans(metrics);
        }

        if (activeView === 'dashboard') {
            updateCashFlowChart(generateProjections());
            updateMonthlyNetChart(generateProjections());
        }
        renderCalendar(projections);
        renderTransactionTable(projections);
        saveData(); // Save ALL settings and data after a successful dashboard update
    }

    function renderCalendar(projections) {
        // ... (Calendar rendering logic remains the same, using currentCalendarSize, showEODBalance)
        const calendarGrid = document.getElementById('calendar-grid');
        document.getElementById('calendar-month-year').textContent = format(currentCalendarDate, 'MMMM yyyy');
        calendarGrid.innerHTML = '';
        const monthStart = startOfMonth(currentCalendarDate);
        const monthEnd = endOfMonth(currentCalendarDate);
        const startDate = startOfWeek(monthStart);
        const endDate = endOfWeek(monthEnd);
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        dailyTransactionMap = {};
        
        days.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = "text-center font-semibold text-sm text-gray-600 py-2";
            dayEl.textContent = day;
            calendarGrid.appendChild(dayEl);
        });
        
        let day = startDate;
        while(day <= endDate) {
            const dateKey = format(day, 'yyyy-MM-dd');
            const dailyTransactions = projections.filter(p => format(p.date, 'yyyy-MM-dd') === dateKey);
            const inCurrentMonth = isSameMonth(day, monthStart);

            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day p-2 border border-gray-200 rounded-md ${!inCurrentMonth ? 'bg-gray-50 text-gray-400' : 'bg-white'}`;
            if (isToday(day)) { dayEl.classList.add('border-blue-500', 'border-2'); }
            
            const dateNumberEl = document.createElement('div');
            dateNumberEl.className = "text-sm font-semibold text-right flex flex-col items-end";
            
            const dateSpan = document.createElement('span');
            dateSpan.textContent = format(day, 'd');
            dateNumberEl.appendChild(dateSpan);
            
            if (showEODBalance && inCurrentMonth) {
                const eodBalance = getEndOfDayBalance(dateKey);
                const balanceDisplay = document.createElement('div');
                
                let balanceColor = 'text-gray-500';
                if (eodBalance >= 1000) balanceColor = 'text-green-600';
                else if (eodBalance < 0) balanceColor = 'text-red-600';

                const roundedEOD = Math.round(eodBalance / 100) / 10;
                
                balanceDisplay.className = `text-xs font-bold ${balanceColor} text-right leading-none truncate`;
                balanceDisplay.textContent = `${roundedEOD.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}k`; 
                
                balanceDisplay.title = `End of Day: $${eodBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                dateNumberEl.appendChild(balanceDisplay);
            }
            
            dayEl.appendChild(dateNumberEl);

            if (inCurrentMonth) {
                dayEl.dataset.date = dateKey;
                dayEl.classList.add('cursor-pointer', 'hover:shadow-lg'); 
                
                if (dailyTransactions.length > 0) {
                    dailyTransactionMap[dateKey] = dailyTransactions;
                    dayEl.classList.add('bg-blue-50');
                }
            }

            
            const transactionList = document.createElement('ul');
            transactionList.className = 'mt-1 space-y-1 text-xs overflow-y-auto'
            dailyTransactions.forEach(t => {
                let colorClass;
                let borderClass = '';
                if (t.type === 'Debt Payment') {
                    colorClass = 'bg-pink-100 text-pink-800';
                    borderClass = 'border-l-2 border-pink-500';
                } else if (t.type === 'One-Time') {
                    colorClass = t.name.includes('(Planned)') ? 'bg-purple-50 text-purple-800' : (t.amount > 0 ? 'bg-purple-100 text-purple-800' : 'bg-red-100 text-red-800');
                    borderClass = 'border-l-2 border-purple-500';
                } else if (t.amount > 0) {
                    colorClass = 'bg-green-100 text-green-800';
                } else {
                    colorClass = 'bg-red-100 text-red-800';
                }
                
                const li = document.createElement('li');
                li.className = `flex items-center p-1 rounded ${colorClass} ${borderClass}`;
                li.innerHTML = `<span class="truncate" title="${t.name}">${t.name}</span> <span class="font-semibold ml-auto">$${Math.abs(t.amount).toFixed(0)}</span>`;
                transactionList.appendChild(li);
            });
            dayEl.appendChild(transactionList);
            calendarGrid.appendChild(dayEl);
            day = addDays(day, 1);
        }
    }
    
    // The rest of the functions (updateKeyMetrics, renderTransactionTable, updateCashFlowChart, updateMonthlyNetChart, calculateTotalWeeks, renderCategoryToggles, generateSpendingPlans, applySpendingPlan, showDashboard) remain logically identical to the original and are included below for completeness.

    function updateKeyMetrics(projections) {
        const startingBalance = parseFloat(startingBalanceEl.value || startingBalanceDashboardEl.value);
        let totalIncome = 0;
        let totalExpenses = 0;
        projections.forEach(p => {
            if (p.amount > 0) totalIncome += p.amount;
            else totalExpenses += p.amount;
        });
        const endBalance = startingBalance + totalIncome + totalExpenses;

        document.getElementById('endBalance').textContent = `$${endBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalExpenses').textContent = `$${Math.abs(totalExpenses).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        return { totalIncome, totalExpenses, endBalance, startingBalance };
    }

    function renderTransactionTable(projections) {
        const tableBody = document.getElementById('transactionTableBody');
        tableBody.innerHTML = '';
        const filter = transactionFilterEl.value;
        const filtered = projections.filter(p => {
            if (filter === 'all') return true;
            if (filter === 'income') return p.amount > 0;
            if (filter === 'expense') return p.amount < 0; 
        });

        if (filtered.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500">No transactions for this period.</td></tr>`;
            return;
        }

        filtered.forEach(p => {
            const row = tableBody.insertRow();
            let typeLabel;
            let amountClass;
            
            if (p.type === 'Debt Payment') {
                typeLabel = 'Debt';
                amountClass = 'text-pink-600';
            } else if (p.type === 'One-Time') {
                typeLabel = p.name.includes('(Planned)') ? 'PLAN' : 'One-Time';
                amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
            } else {
                typeLabel = 'Recurring';
                amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${format(p.date, 'MMM dd, yyyy')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${p.name} <span class="text-xs text-gray-400">(${typeLabel})</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${amountClass}">${p.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
            `;
        });
    }

    function updateCashFlowChart(projections) {
        const ctx = document.getElementById('cashFlowChart').getContext('2d');
        const startingBalance = parseFloat(startingBalanceEl.value);
        let currentBalance = startingBalance;
        
        const dataPoints = [{ x: new Date(startDateEl.value + 'T00:00:00'), y: startingBalance }];
        projections.forEach(p => {
            currentBalance += p.amount;
            dataPoints.push({ x: p.date, y: currentBalance });
        });

        if (cashFlowChart) cashFlowChart.destroy();
        cashFlowChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Projected Balance',
                    data: dataPoints,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'month' } },
                    y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } }
                },
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: (context) => ` Balance: ${context.formattedValue}`
                        }
                    }
                }
            }
        });
    }
    
    function updateMonthlyNetChart(projections) {
        const ctx = document.getElementById('monthlyNetChart').getContext('2d');
        const monthlyData = {};
        projections.forEach(p => {
            const month = format(p.date, 'yyyy-MM');
            if (!monthlyData[month]) monthlyData[month] = 0;
            monthlyData[month] += p.amount;
        });

        const labels = Object.keys(monthlyData).sort();
        const data = labels.map(label => monthlyData[label]);

        if (monthlyNetChart) monthlyNetChart.destroy();
        monthlyNetChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => format(new Date(l + '-02T00:00:00'), 'MMM yyyy')),
                datasets: [{
                    label: 'Net Monthly Flow',
                    data: data,
                    backgroundColor: data.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.7)' : 'rgba(220, 38, 38, 0.7)'),
                    borderColor: data.map(v => v >= 0 ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } } }
            }
        });
    }
    
    function calculateTotalWeeks(startDate, projectionMonths) {
        const start = parseISO(startDate);
        const end = addMonths(start, projectionMonths);
        let weeks = 0;
        let currentWeekStart = startOfISOWeek(start);

        while (isBefore(currentWeekStart, end)) {
            weeks++;
            currentWeekStart = addDays(currentWeekStart, 7);
        }
        return weeks;
    }
    
    function renderCategoryToggles(categories) {
        categoryTogglesEl.innerHTML = '';
        categories.forEach(cat => {
            const info = cat.fixedWeeklyAmount > 0 
                ? `($${cat.fixedWeeklyAmount.toFixed(2)} Fixed/Week)` 
                : `(${cat.percentage}% Allocation)`;

            const item = document.createElement('div');
            item.className = 'flex items-center space-x-3 p-3 bg-gray-100 rounded-lg';
            item.innerHTML = `
                <input type="checkbox" id="toggle-${cat.name.replace(/\s/g, '-')}" data-category="${cat.name}" ${cat.enabled ? 'checked' : ''} class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                <label for="toggle-${cat.name.replace(/\s/g, '-')}" class="text-sm font-medium text-gray-900 cursor-pointer flex-grow">
                    ${cat.name} <span class="text-xs text-gray-500">${info}</span>
                </label>
            `;
            categoryTogglesEl.appendChild(item);
        });
    }
    
    function generateSpendingPlans(metrics) {
        const totalSavings = metrics.endBalance - metrics.startingBalance;
        const projectionMonths = parseInt(projectionMonthsEl.value);
        const startDate = startDateEl.value;
        const totalWeeks = calculateTotalWeeks(startDate, projectionMonths);

        document.getElementById('savings-projection').textContent = `$${totalSavings.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        const sliderMax = Math.max(0, Math.floor(totalSavings / 100) * 100);
        savingsSliderEl.max = sliderMax.toFixed(0); 
        savingsSliderEl.value = Math.min(savedAmount, sliderMax).toFixed(0);
        savedAmount = parseFloat(savingsSliderEl.value);
        
        const percentage = (sliderMax > 0) ? (savedAmount / sliderMax) * 100 : 0;
        savingsSliderEl.style.setProperty('--slider-progress', `${percentage}%`);
        savedAmountDisplayEl.textContent = `$${savedAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

        const remainingBudget = totalSavings - savedAmount;
        
        if (remainingBudget <= 0) {
            remainingBudgetBaseEl.textContent = '$0.00';
            planButtonsEl.innerHTML = `<p class="text-red-500 font-semibold p-4 bg-red-100 rounded-lg">Warning: Your selected savings goal ($${savedAmount.toLocaleString()}) exceeds or equals the projected surplus. No budget available for spending plans.</p>`;
            renderCategoryToggles(activeSpendingCategories);
            return;
        }

        const baseWeeklyBudget = remainingBudget / totalWeeks;
        remainingBudgetBaseEl.textContent = `$${remainingBudget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        const planDefinitions = [
            { name: 'Aggressive Spending (100% Budget)', margin: 1.00, buttonClass: 'bg-red-600 hover:bg-red-700' }, 
            { name: 'Balanced Spending (75% Budget)', margin: 0.75, buttonClass: 'bg-blue-600 hover:bg-blue-700' },    
            { name: 'Conservative Spending (50% Budget)', margin: 0.50, buttonClass: 'bg-green-600 hover:bg-green-700' } 
        ];

        planButtonsEl.innerHTML = '';
        
        const enabledCategories = activeSpendingCategories.filter(c => c.enabled);
        
        const totalFixedWeeklyCost = enabledCategories.filter(c => c.fixedWeeklyAmount > 0)
                                                     .reduce((sum, cat) => sum + cat.fixedWeeklyAmount, 0);

        const variableCategories = enabledCategories.filter(c => c.fixedWeeklyAmount === 0);
        const totalVariablePercentage = variableCategories.reduce((sum, cat) => sum + cat.percentage, 0);
        
        renderCategoryToggles(activeSpendingCategories);

        planDefinitions.forEach(plan => {
            const weeklyBudgetForVariable = (baseWeeklyBudget * plan.margin) - totalFixedWeeklyCost;
            
            const totalWeeklyAllocation = totalFixedWeeklyCost + (weeklyBudgetForVariable > 0 ? weeklyBudgetForVariable : 0);
            
            const categoryBreakdown = enabledCategories.map(cat => {
                let amount;
                let isFixed = cat.fixedWeeklyAmount > 0;
                
                if (isFixed) {
                    amount = cat.fixedWeeklyAmount;
                } else {
                    if (weeklyBudgetForVariable > 0 && totalVariablePercentage > 0) {
                        amount = (weeklyBudgetForVariable * (cat.percentage / totalVariablePercentage));
                    } else {
                        amount = 0;
                    }
                }
                
                if (cat.name === 'Gas/Fuel' && !isFixed) {
                    if (amount > 100) amount = 100;
                    if (amount < 30) amount = 30;
                }
                
                amount = Math.max(0, amount); 
                
                return {
                    name: cat.name,
                    amount: amount
                };
            });
            
            const breakdownHtml = categoryBreakdown.filter(i => i.amount > 0.01).map(item => `
                <li class="flex justify-between text-sm text-gray-700">
                    <span>${item.name}:</span>
                    <span class="font-medium text-red-600">$${item.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                </li>
            `).join('');

            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200';
            card.innerHTML = `
                <h3 class="text-lg font-bold mb-3">${plan.name}</h3>
                <p class="text-sm text-gray-500">
                    Saves ${((1 - plan.margin) * 100).toFixed(0)}% of the **Remaining Budget** (after fixed savings goal).
                </p>
                <p class="text-lg font-semibold text-gray-900 mb-2 mt-2">
                    Total Weekly Plan: $${totalWeeklyAllocation.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
                <ul class="list-disc list-inside space-y-1 ml-4 mb-4">
                    ${breakdownHtml || '<li class="text-gray-500 italic">No budget allocated to selected categories.</li>'}
                </ul>
                <button data-plan='${JSON.stringify({ breakdown: categoryBreakdown, name: plan.name })}' 
                        class="apply-plan-btn w-full py-2 text-white font-semibold rounded-lg ${plan.buttonClass}">
                    Select Plan & Generate Expenses
                </button>
            `;
            planButtonsEl.appendChild(card);
        });
    }

    function applySpendingPlan(planData) {
        if (!confirm(`Are you sure you want to apply the ${planData.name} and clear any existing planned weekly budgets?`)) {
            return;
        }

        oneTimeTransactions = oneTimeTransactions.filter(t => !t.name.includes('(Planned)'));
        
        const breakdown = planData.breakdown;
        const startDate = startDateEl.value;
        const projectionMonths = parseInt(projectionMonthsEl.value);
        
        const totalWeeks = calculateTotalWeeks(startDate, projectionMonths);
        let currentWeekStart = startOfISOWeek(parseISO(startDate));
        const limitDate = addMonths(parseISO(startDate), projectionMonths);
        let transactionCount = 0;

        for (let i = 0; i < totalWeeks; i++) {
            const weekDate = addDays(currentWeekStart, 4);
            
            if (isBefore(weekDate, limitDate) || isSameDay(weekDate, limitDate)) {

                breakdown.forEach(cat => {
                    const amount = cat.amount;
                    
                    if (amount > 0.01) {
                        const finalAmount = -amount;
                        
                        oneTimeTransactions.push({
                            id: `PLAN-${Date.now()}-${i}-${cat.name}`,
                            name: `${cat.name} (Planned)`,
                            amount: finalAmount,
                            date: format(weekDate, 'yyyy-MM-dd'),
                            type: 'One-Time'
                        });
                        transactionCount++;
                    }
                });
            }
            currentWeekStart = addDays(currentWeekStart, 7);
        }

        showStatus(`Generated ${transactionCount} planned weekly expenses for the forecast!`, 'bg-blue-100 text-blue-700');
        saveAndRender();
    }


    async function showDashboard() {
        addEventListeners();
        
        // Check authentication status first
        const authStatus = await checkAuthStatus();
        
        if (authStatus.logged_in) {
            // If logged in, load data from the cloud and show the main view
            await loadData();
            changeView('calendar');
        } else {
            // If not logged in, show the account view
            await loadData(); // Load local defaults to prevent blank variables
            changeView('account');
        }
        
        // Initial rendering based on loaded data (or defaults)
        renderSchedules();
        renderDebtPlans(); 
        updateDashboard();
    }
    
});
```
