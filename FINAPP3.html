<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive FinPlan Dashboard</title>
    <!-- CRUCIAL CONFIGURATION FOR FULL-SCREEN APP MODE ON IPHONE -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FinPlan">
    <!-- APP ICON CONFIGURATION -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/047857/ffffff?text=%24%E2%9C%93">
    <!-- END FULL-SCREEN CONFIGURATION -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* FIX: Adjusted padding-top to normal and set padding-bottom to 150px for max bottom clearance */
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; color: #343a40; padding-top: 16px; padding-bottom: 150px; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .modal { transition: opacity 0.25s ease; }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-inactive { opacity: 0; pointer-events: none; }
        .calendar-grid { grid-template-rows: auto repeat(6, minmax(0, 1fr)); }
        .calendar-day { min-height: 100px; }
        .toggle-checkbox:checked { right: 0; border-color: #48BB78; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48BB78; }
        .active-nav { border-b-2 border-blue-600 text-blue-600 font-semibold; }
        
        /* NEW FIXED BOTTOM NAV STYLING */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            border-top: 1px solid #E5E7EB;
            z-index: 40;
            height: 90px;
            padding-top: 10px;
            padding-bottom: 30px; /* Lift buttons higher */
        }
        /* Custom styling for the slider track */
        input[type=range]::-webkit-slider-runnable-track {
            height: 8px;
            background: linear-gradient(to right, #4ade80 0%, #4ade80 var(--slider-progress, 0%), #d1d5db var(--slider-progress, 0%), #d1d5db 100%);
            border-radius: 4px;
        }
        input[type=range]::-moz-range-track {
            height: 8px;
            background: linear-gradient(to right, #4ade80 0%, #4ade80 var(--slider-progress, 0%), #d1d5db var(--slider-progress, 0%), #d1d5db 100%);
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #10b981; /* Green color for thumb */
            margin-top: -6px; /* Center thumb vertically */
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* NEW: Responsive Font Sizing for Calendar Days */
        /* Small Size Styles - TIGHTER CONSTRAINTS */
        /* Targets date number, EOD balance amount, and transaction amounts */
        .calendar-day-text-sm .text-sm { font-size: 0.65rem; /* ~10.4px */ }
        /* Targets EOD Balance label and transaction descriptions (originally text-xs) */
        .calendar-day-text-sm .text-xs { font-size: 0.55rem; /* ~8.8px */ }
        /* Targets transaction text and amount (font-bold is only used in EOD span for color) */
        .calendar-day-text-sm .font-bold { font-size: 0.65rem; } 
        /* Targets the date/EOD container element for overall height control */
        .calendar-day-text-sm .text-sm.font-semibold { font-size: 0.65rem; }
        .calendar-day-text-sm .truncate { max-width: 60%; } /* Prevent overflow on transaction names */

        /* Medium Size Styles (Slightly reduced) */
        .calendar-day-text-medium .text-sm { font-size: 0.875rem; /* text-sm */ }
        .calendar-day-text-medium .text-xs { font-size: 0.75rem; /* text-xs */ }
        .calendar-day-text-medium .font-bold { font-size: 0.875rem; }
    </style>
</head>
<body class="antialiased">
    
    <!-- STATUS MESSAGE BAR (FIXED AT TOP) -->
    <div id="status-message" class="fixed top-0 left-0 right-0 p-3 text-center text-sm font-medium transition duration-300 opacity-0 z-50"></div>
    
    <div class="container mx-auto p-4 sm:p-6 md:p-8">

        <main class="space-y-8 md:space-y-12">
            
            <!-- Dynamic Header -->
            <header class="text-center mb-4 md:mb-6">
                <h1 class="3xl md:text-4xl font-bold text-gray-800">FinPlan</h1>
                <h2 id="page-title" class="text-xl font-semibold text-gray-700 mt-2">Calendar</h2>
                <div id="user-status" class="text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded-lg">
                    Status: Local Mode (Data saved to this device only)
                </div>
            </header>

            <!-- 1. CALENDAR VIEW (HOME VIEW) -->
            <div id="view-calendar" class="view-container space-y-8">
                
                <section id="calendar-view" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">Transaction Calendar</h2>
                        <button id="add-one-time-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">Add One-Time Event</button>
                    </div>
                    <p class="text-center text-gray-500 mb-6 max-w-2xl mx-auto">This calendar displays all your financial events—recurring, one-time, and debt payments—for the selected month.</p>
                    <div id="calendar-controls" class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">&larr; Prev</button>
                        <h3 id="calendar-month-year" class="text-xl font-semibold"></h3>
                        <button id="next-month" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Next &rarr;</button>
                    </div>
                    <!-- Calendar Grid Wrapper (FIXED: Added overflow-x-auto for mobile scrolling) -->
                    <div class="overflow-x-auto">
                        <!-- Added initial size via JS on load, set here as default placeholder -->
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 calendar-grid min-w-[700px]"></div>
                    </div>
                    
                    <!-- NEW: Calendar Size Controls -->
                    <div class="flex flex-col items-center mt-6 pt-4 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Calendar Controls:</p>
                        <div class="flex justify-center space-x-3 mb-4">
                            <button data-size="small" class="calendar-size-btn px-4 py-1 text-sm rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300">Small</button>
                            <button data-size="medium" class="calendar-size-btn px-4 py-1 text-sm rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300">Medium</button>
                            <button data-size="large" class="calendar-size-btn px-4 py-1 text-sm rounded-full bg-blue-600 text-white hover:bg-blue-700">Large</button>
                        </div>
                        
                        <!-- NEW: EOD Balance Toggle -->
                        <div class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg">
                            <input type="checkbox" id="toggleEODBalance" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                            <label for="toggleEODBalance" class="text-sm font-medium text-gray-700">Show End of Day Balance</label>
                        </div>
                        
                    </div>
                </section>

                <!-- Projection Settings (MAIN CONTROL INPUTS) -->
                <section id="projection-controls" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Settings</h2>
                        <!-- MANUAL SAVE BUTTON ADDED -->
                        <button id="manual-save-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Save Settings</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Projection Start Date</label>
                            <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="projectionMonths" class="block text-sm font-medium text-gray-700 mb-1">Projection Length (Months)</label>
                            <select id="projectionMonths" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12" selected>12 Months</option>
                                <option value="24">24 Months</option>
                            </select>
                        </div>
                        <div>
                            <label for="startingBalance" class="block text-sm font-medium text-gray-700 mb-1">Starting Balance ($)</label>
                            <input type="number" id="startingBalance" value="5000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    </section>
            </div>
            
            <!-- 2. DASHBOARD VIEW (CHARTS & METRICS - MOVED PROJECTION SETTINGS HERE) -->
            <div id="view-dashboard" class="view-container hidden space-y-8">
                
                <section id="key-metrics" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="text-md font-semibold text-gray-500">Projected End Balance</h3><p id="endBalance" class="text-3xl font-bold text-gray-800 mt-2">$0.00</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="text-md font-semibold text-gray-500">Total Income</h3><p id="totalIncome" class="3xl font-bold text-green-600 mt-2">$0.00</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="text-md font-semibold text-gray-500">Total Expenses</h3><p id="totalExpenses" class="3xl font-bold text-red-600 mt-2">$0.00</p></div>
                </section>
                
                <section id="visualizations" class="bg-white p-6 rounded-2xl shadow-sm space-y-12">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Cash Flow Projection</h2>
                        <p class="text-center text-gray-500 mb-4 max-w-2xl mx-auto">This chart shows the projected running balance over time, helping you anticipate future highs and lows.</p>
                        <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
                    </div>
                    <div>
                         <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Net Monthly Flow</h2>
                        <p class="text-center text-gray-500 mb-4 max-w-2xl mx-auto">This bar chart illustrates the net financial result for each month—the difference between total income and total expenses.</p>
                        <div class="chart-container"><canvas id="monthlyNetChart"></canvas></div>
                    </div>
                </section>

                <!-- PROJECTION CONTROLS MOVED TO DASHBOARD BOTTOM -->
                <section id="projection-controls-dashboard" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Projection Settings</h2>
                        <!-- MANUAL SAVE BUTTON ADDED -->
                        <button id="manual-save-btn-dashboard" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Save Settings</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Projection Start Date</label>
                            <input type="date" id="startDate_dashboard" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="projectionMonths" class="block text-sm font-medium text-gray-700 mb-1">Projection Length (Months)</label>
                            <select id="projectionMonths_dashboard" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12" selected>12 Months</option>
                                <option value="24">24 Months</option>
                            </select>
                        </div>
                        <div>
                            <label for="startingBalance" class="block text-sm font-medium text-gray-700 mb-1">Starting Balance ($)</label>
                            <input type="number" id="startingBalance_dashboard" value="5000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </section>
                
            </div>
            <!-- END DASHBOARD VIEW -->

            <!-- 3. DEBT MANAGEMENT VIEW -->
            <div id="view-debt" class="view-container hidden space-y-8">
                <section id="debt-plan-management" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Debt Plan Management</h2>
                        <button id="add-debt-plan-btn" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">Add New Debt Plan</button>
                    </div>
                    <p class="text-gray-500 mb-6">Define structured debt repayments here. Payments are calculated based on the payoff period and automatically removed from the forecast once completed.</p>
                    <div id="debtPlansList" class="space-y-4"></div>
                </section>
                
            </div>
            
            <!-- 4. RECURRING SCHEDULES VIEW -->
            <div id="view-schedules" class="view-container hidden space-y-8">
                <section id="schedules-management" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Recurring Schedules Management</h2>
                        <button id="add-schedule-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Add New Recurring Schedule</button>
                    </div>
                    <p class="text-gray-500 mb-6">Manage all your **long-term, repeating** financial events here. Toggle items to run "what-if" scenarios.</p>
                    <div id="schedulesList" class="space-y-4"></div>
                </section>
            </div>

            <!-- 5. SPENDING PLAN VIEW (NEW) -->
            <div id="view-plan" class="view-container hidden space-y-8">
                <section id="plan-intro" class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Projected Surplus Analysis</h2>
                    <p class="text-gray-600 mb-4">Analyze your projected cash surplus over the selected period. Use the controls below to set your savings target and customize the weekly budget categories.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h3 class="text-md font-semibold text-gray-500">Projected Savings Over Period</h3>
                            <p id="savings-projection" class="text-2xl font-bold text-green-700 mt-1">$0.00</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h3 class="text-md font-semibold text-gray-500">Available Weekly Spending</h3>
                            <p id="weekly-spending-base" class="text-2xl font-bold text-blue-700 mt-1">$0.00</p>
                        </div>
                    </div>
                </section>
                
                <!-- Savings Target & Category Controls (NEW) -->
                <section id="plan-controls" class="bg-white p-6 rounded-2xl shadow-sm space-y-6">
                    <h2 class="text-xl font-bold text-gray-800">Savings Target & Customization</h2>

                    <!-- Savings Slider -->
                    <div class="pt-2">
                        <label for="savings-slider" class="block text-sm font-medium text-gray-700 mb-2">
                            Amount to Commit to Savings: <span id="saved-amount-display" class="font-bold text-xl text-green-700">$0</span>
                        </label>
                        <!-- Custom CSS handles the dynamic progress bar -->
                        <input type="range" id="savings-slider" min="0" max="0" value="0" step="10" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg"
                               style="--slider-progress: 0%;">
                        <p class="text-xs text-gray-500 mt-1">Slide to set your desired savings amount from your projected surplus.</p>
                    </div>

                    <!-- Remaining Budget Display -->
                    <div class="p-4 bg-blue-100 rounded-xl text-center border border-blue-200">
                        <h3 class="text-md font-semibold text-blue-800">Remaining Budget for Weekly Spending:</h3>
                        <p id="remaining-budget-base" class="text-3xl font-bold text-blue-700 mt-1">$0.00</p>
                    </div>

                    <!-- Category Toggles -->
                    <div class="pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-3">Included Spending Categories:</h3>
                        <div id="category-toggles" class="grid grid-cols-2 gap-4">
                            <!-- Toggles generated by JS -->
                        </div>
                    </div>
                </section>
                
                <!-- Plan Options -->
                <section id="plan-creator" class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Weekly Budget Allocation Plans</h2>
                    <p class="text-gray-500 mb-6">Select a plan to spend a percentage of your **Remaining Budget** on the selected categories, and generate the weekly transactions.</p>
                    <div id="plan-buttons" class="space-y-4">
                        <!-- Plans will be generated here -->
                    </div>
                </section>
                
                <!-- Delete Plan Section (NEW) -->
                <section class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-red-700 mb-4">Manage Current Plan</h2>
                    <p class="text-sm text-gray-600 mb-4">Use this button to quickly remove all existing planned expenses (transactions tagged "(Planned)") from your forecast.</p>
                    <button id="delete-plan-btn" class="w-full py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">
                        Delete Current Spending Plan & Transactions
                    </button>
                </section>
            </div>
            <!-- END SPENDING PLAN VIEW -->


            <!-- 6. TRANSACTION LOG VIEW -->
            <div id="view-log" class="view-container hidden space-y-8">
                 <section id="transaction-log" class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Projected Transaction Log</h2>
                    <p class="text-gray-500 mb-6">A detailed, day-by-day list of all projected transactions (recurring, one-time, and debt payments). Filter by type for a granular analysis.</p>
                    <div class="mb-4">
                         <select id="transactionFilter" class="p-2 border border-gray-300 rounded-lg">
                             <option value="all">All Transactions</option><option value="income">Income Only</option><option value="expense">Expenses Only</option>
                         </select>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th></tr></thead><tbody id="transactionTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </section>
            </div>
            
        </main>
    </div>

    <!-- NAVIGATION BAR (Fixed at Bottom) -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 h-16 py-2">
            <!-- Scrollable Button Container (Fixed to be centered and horizontally scrollable) -->
            <div class="flex overflow-x-auto flex-nowrap space-x-4 h-full items-center justify-center">
                <button data-view="calendar" data-name="Calendar" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0 active-nav">Calendar</button>
                <button data-view="dashboard" data-name="Dashboard" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Dashboard</button>
                <button data-view="debt" data-name="Debt Plans" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Debt Plans</button>
                <button data-view="schedules" data-name="Recurring Schedules" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Recurring</button>
                <button data-view="plan" data-name="Spending Plan" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Plan</button>
                <button data-view="log" data-name="Transaction Log" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition flex-shrink-0">Log</button>
            </div>
        </div>
    </nav>


    <!-- Modals (Global, accessible from all views) -->
    
    <!-- Modal for Daily Transaction Details (NEW) -->
    <div id="day-details-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 id="day-details-title" class="2xl font-bold mb-6">Transactions on [Date]</h3>
            <div id="day-details-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Transaction items go here -->
            </div>
            <div class="mt-8 flex justify-between">
                <!-- NEW: Button to open One-Time Modal, passes the date key -->
                <button type="button" id="add-from-day-details" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold" data-date="">+ One-Time Event</button>
                <button type="button" id="close-day-details-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>
    <!-- End Modal for Daily Transaction Details -->

    <!-- Modal for Recurring Schedules (Complex) -->
    <div id="schedule-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 id="modal-title" class="2xl font-bold mb-6">Add New Schedule</h3>
            <form id="schedule-form">
                <input type="hidden" id="schedule-id">
                <div class="space-y-4">
                    <div><label for="name" class="block text-sm font-medium">Name</label><input type="text" id="name" required class="w-full p-2 border rounded-lg"></div>
                    
                    <!-- RECURRING SCHEDULE TYPE TOGGLE (NEW) -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Amount Type</label>
                        <div class="flex rounded-lg border border-gray-300 overflow-hidden" id="schedule-type-toggle">
                            <button type="button" data-type="expense" data-current="expense" class="flex-1 p-2 font-semibold text-center bg-red-100 text-red-700 transition">Expense</button>
                            <button type="button" data-type="income" class="flex-1 p-2 font-semibold text-center text-gray-700 bg-white border-l transition">Income</button>
                        </div>
                        <div><label for="amount" class="block text-sm font-medium">Amount ($)</label><input type="number" step="0.01" min="0" id="amount" required class="w-full p-2 border rounded-lg"></div>
                    </div>
                    <!-- END RECURRING SCHEDULE TYPE TOGGLE -->
                    
                    <div><label for="start_date" class="block text-sm font-medium">Start Date</label><input type="date" id="start_date" required class="w-full p-2 border rounded-lg"></div>
                    <div>
                        <label for="frequency" class="block text-sm font-medium">Frequency</label>
                        <select id="frequency" required class="w-full p-2 border rounded-lg">
                            <option value="Monthly">Monthly</option>
                            <option value="Weekly">Weekly</option>
                            <option value="BiWeekly">Bi-Weekly</option> <!-- ADDED BI-WEEKLY OPTION -->
                        </select>
                    </div>
                    <div id="day-value-monthly"><label for="day_value_month" class="block text-sm font-medium">Day of Month (1-31)</label><input type="number" id="day_value_month" min="1" max="31" class="w-full p-2 border rounded-lg"></div>
                    <div id="day-value-weekly" class="hidden"><label for="day_value_week" class="block text-sm font-medium">Day of Week</label><select id="day_value_week" class="w-full p-2 border rounded-lg"><option>Sunday</option><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4"><button type="button" class="cancel-btn px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Schedule</button></div>
            </form>
        </div>
    </div>

    <!-- Modal for One-Time Transactions (Simple) -->
    <div id="onetime-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 class="2xl font-bold mb-6">Add One-Time Transaction</h3>
            <form id="onetime-form">
                <input type="hidden" id="onetime-id">
                <div class="space-y-4">
                    <div><label for="onetime-name" class="block text-sm font-medium">Name</label><input type="text" id="onetime-name" required class="w-full p-2 border rounded-lg"></div>
                    
                    <!-- ONE-TIME TRANSACTION TYPE TOGGLE (NEW) -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Amount Type</label>
                        <div class="flex rounded-lg border border-gray-300 overflow-hidden" id="onetime-type-toggle">
                            <button type="button" data-type="expense" data-current="expense" class="flex-1 p-2 font-semibold text-center bg-red-100 text-red-700 transition">Expense</button>
                            <button type="button" data-type="income" class="flex-1 p-2 font-semibold text-center text-gray-700 bg-white border-l transition">Income</button>
                        </div>
                        <div><label for="onetime-amount" class="block text-sm font-medium">Amount ($)</label><input type="number" step="0.01" min="0" id="onetime-amount" required class="w-full p-2 border rounded-lg"></div>
                    </div>
                    <!-- END ONE-TIME TRANSACTION TYPE TOGGLE -->
                    
                    <div><label for="onetime-date" class="block text-sm font-medium">Date of Transaction</label><input type="date" id="onetime-date" required class="w-full p-2 border rounded-lg"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" class="cancel-btn px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Debt Plan -->
    <div id="debt-plan-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 id="debt-modal-title" class="2xl font-bold mb-6">Add New Debt Plan</h3>
            <form id="debt-plan-form">
                <input type="hidden" id="debt-id">
                <div class="space-y-4">
                    <div><label for="debt-name" class="block text-sm font-medium">Debt Name</label><input type="text" id="debt-name" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="total-amount" class="block text-sm font-medium">Total Debt Amount ($)</label><input type="number" step="0.01" id="total-amount" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="payoff-months" class="block text-sm font-medium">Payoff Months (e.g., 12)</label><input type="number" id="payoff-months" min="1" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="debt-start-date" class="block text-sm font-medium">First Payment Date</label><input type="date" id="debt-start-date" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="debt-pay-day" class="block text-sm font-medium">Payment Day of Month (1-31)</label><input type="number" id="debt-pay-day" min="1" max="31" required class="w-full p-2 border rounded-lg"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" class="cancel-btn-debt px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700">Save Debt Plan</button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
import { addMonths, eachDayOfInterval, format, getDay, getDate, endOfMonth, startOfMonth, startOfWeek, endOfWeek, addDays, isSameMonth, isToday, subMonths, parseISO, subDays, getISOWeek, startOfWeek as startOfISOWeek, endOfWeek as endOfISOWeek, isBefore, isSameDay } from 'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/esm/index.js';

// =========================================================================
// DOM ACCESS HELPERS (For safe access during async startup)
// =========================================================================
function getUserStatusEl() { return document.getElementById('user-status'); }
function getPageTitleEl() { return document.getElementById('page-title'); }

// Function to synchronously initialize all DOM elements (moved out of listener for scope fix)
let startDateEl, projectionMonthsEl, startingBalanceEl, startDateDashboardEl, projectionMonthsDashboardEl, startingBalanceDashboardEl;
let schedulesListEl, debtPlansListEl, transactionFilterEl, statusMessageEl, manualSaveBtn, manualSaveBtnDashboard, planButtonsEl;
let scheduleModal, oneTimeModal, debtPlanModal, dayDetailsModal;
let scheduleForm, oneTimeForm, debtPlanForm;
let scheduleIdInput, frequencySelect, debtIdInput;
let navButtons, viewContainers, calendarGridEl, calendarSizeButtons;

// NEW ELEMENTS FOR PLAN VIEW
let savingsSliderEl, savedAmountDisplayEl, remainingBudgetBaseEl, categoryTogglesEl, deletePlanBtnEl;
let toggleEODBalanceEl; // NEW ELEMENT

function initDomElements() {
    startDateEl = document.getElementById('startDate');
    projectionMonthsEl = document.getElementById('projectionMonths');
    startingBalanceEl = document.getElementById('startingBalance');
    // Dashboard elements
    startDateDashboardEl = document.getElementById('startDate_dashboard');
    projectionMonthsDashboardEl = document.getElementById('projectionMonths_dashboard');
    startingBalanceDashboardEl = document.getElementById('startingBalance_dashboard');
    schedulesListEl = document.getElementById('schedulesList');
    debtPlansListEl = document.getElementById('debtPlansList');
    transactionFilterEl = document.getElementById('transactionFilter');
    statusMessageEl = document.getElementById('status-message'); 
    manualSaveBtn = document.getElementById('manual-save-btn'); 
    manualSaveBtnDashboard = document.getElementById('manual-save-btn-dashboard');
    planButtonsEl = document.getElementById('plan-buttons'); 

    scheduleModal = document.getElementById('schedule-modal');
    oneTimeModal = document.getElementById('onetime-modal');
    debtPlanModal = document.getElementById('debt-plan-modal'); 
    dayDetailsModal = document.getElementById('day-details-modal'); 

    scheduleForm = document.getElementById('schedule-form');
    oneTimeForm = document.getElementById('onetime-form');
    debtPlanForm = document.getElementById('debt-plan-form'); 

    scheduleIdInput = document.getElementById('schedule-id');
    frequencySelect = document.getElementById('frequency');
    debtIdInput = document.getElementById('debt-id'); 
    
    navButtons = document.querySelectorAll('.nav-btn');
    viewContainers = document.querySelectorAll('.view-container');
    calendarGridEl = document.getElementById('calendar-grid');
    calendarSizeButtons = document.querySelectorAll('.calendar-size-btn');
    
    // NEW ELEMENTS FOR PLAN VIEW
    savingsSliderEl = document.getElementById('savings-slider');
    savedAmountDisplayEl = document.getElementById('saved-amount-display');
    remainingBudgetBaseEl = document.getElementById('remaining-budget-base');
    categoryTogglesEl = document.getElementById('category-toggles');
    deletePlanBtnEl = document.getElementById('delete-plan-btn'); 
    
    toggleEODBalanceEl = document.getElementById('toggleEODBalance');
}
// =========================================================================


document.addEventListener('DOMContentLoaded', async () => {
    
    // FIX: Call synchronous initialization function immediately upon DOMContentLoaded
    initDomElements();

    // =========================================================================
    // 1. CORE APPLICATION VARIABLES
    // =========================================================================
    let recurringSchedules = [];
    let oneTimeTransactions = [];
    let debtPlans = []; 
    let currentCalendarDate = new Date();
    let activeView = 'calendar'; 
    let dailyTransactionMap = {}; 
    let dailyBalanceMap = {}; 
    
    // Global variable for the selected savings amount (synced from local storage)
    let savedAmount = 0; 
    let showEODBalance = localStorage.getItem('showEODBalance') === 'true'; // NEW: EOD Balance toggle state

    const defaultSchedules = [
        { id: 'RENT-01', name: 'Monthly Rent Payment', amount: -1010.00, startDate: '2024-01-03', frequency: 'Monthly', dayValue: 3, enabled: true },
        { id: 'SALARY-01', name: 'Weekly Salary', amount: 1000.00, startDate: '2024-01-04', frequency: 'Weekly', dayValue: 'Thursday', enabled: true },
    ];
    
    const weeklyDayMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
    
    let cashFlowChart, monthlyNetChart;
    
    // Calendar Size Definitions (MOVED TO GLOBAL SCOPE FOR CLEANUP)
    const calendarSizes = {
        'small': '320px', // Adjusted to fit most vertical screens
        'medium': '450px', 
        'large': '600px'  
    };
    let currentCalendarSize = localStorage.getItem('calendarSize') || 'large'; 
    
    // NEW: Updated SPENDING_CATEGORIES structure
    const SPENDING_CATEGORIES = [
        { name: 'Groceries', percentage: 40, fixedWeeklyAmount: 0, defaultEnabled: true },
        { name: 'Gas/Fuel', percentage: 30, fixedWeeklyAmount: 0, defaultEnabled: true },
        { name: 'Misc. Spending', percentage: 30, fixedWeeklyAmount: 0, defaultEnabled: true },
        // Transportation category added as requested
        { name: 'Transportation', percentage: 0, fixedWeeklyAmount: 50.00, defaultEnabled: false } 
    ];
    // This array holds the runtime status (enabled/disabled) of the categories
    let activeSpendingCategories = []; 
    
    // =========================================================================
    // 2. APP STARTUP
    // =========================================================================
    if (getUserStatusEl()) {
        getUserStatusEl().textContent = `Status: Local Mode (Data saved to this device only)`;
    }
    showDashboard();
    // --- END APP STARTUP ---


    function showDashboard() {
        // Initial setup calls
        // Ensure initial values are set BEFORE loadData reads them
        startDateEl.value = format(new Date(), 'yyyy-MM-dd');
        startingBalanceEl.value = localStorage.getItem('startingBalance') || '5000'; 
        
        loadData();
        renderSchedules();
        renderDebtPlans(); 
        setCalendarSize(currentCalendarSize); // Set initial size
        addEventListeners();
        changeView(activeView); // Set initial view to calendar
        updateDashboard();
    }
    
    // Displays a temporary status message
    function showStatus(message, colorClass) {
        if (statusMessageEl) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `fixed top-0 left-0 right-0 p-3 text-center text-sm font-medium transition duration-300 ${colorClass} shadow-lg`;
            statusMessageEl.classList.remove('opacity-0');
            statusMessageEl.classList.add('opacity-100');
            setTimeout(() => {
                statusMessageEl.classList.remove('opacity-100');
                statusMessageEl.classList.add('opacity-0');
            }, 5000);
        }
    }

    // NEW FUNCTION: Sets the calendar size and updates button visuals
    function setCalendarSize(size) {
        if (calendarSizes[size]) {
            currentCalendarSize = size;
            localStorage.setItem('calendarSize', size);
            calendarGridEl.style.minWidth = calendarSizes[size];
            
            // NEW: Add responsive text class based on size
            calendarGridEl.classList.remove('calendar-day-text-sm', 'calendar-day-text-medium');
            if (size === 'small') {
                calendarGridEl.classList.add('calendar-day-text-sm');
            } else if (size === 'medium') {
                calendarGridEl.classList.add('calendar-day-text-medium');
            }

            // Update button visuals
            calendarSizeButtons.forEach(btn => {
                const isSelected = btn.dataset.size === size;
                btn.classList.toggle('bg-blue-600', isSelected);
                btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('bg-gray-200', !isSelected);
                btn.classList.toggle('text-gray-800', !isSelected);
            });
        }
    }
    
    // NEW: Function to manage the visual state of the Income/Expense toggles
    function setToggleVisuals(containerId, type) {
        const toggleContainer = document.getElementById(containerId);
        const expenseBtn = toggleContainer.querySelector('[data-type="expense"]');
        const incomeBtn = toggleContainer.querySelector('[data-type="income"]');

        if (type === 'income') {
            incomeBtn.classList.remove('bg-white', 'text-gray-700', 'border-l');
            incomeBtn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            expenseBtn.classList.remove('bg-red-100', 'text-red-700');
            expenseBtn.classList.add('bg-white', 'text-gray-700');
            incomeBtn.dataset.current = 'income';
            expenseBtn.dataset.current = '';
        } else { // default to expense
            expenseBtn.classList.remove('bg-white', 'text-gray-700');
            expenseBtn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            incomeBtn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
            incomeBtn.classList.add('bg-white', 'text-gray-700', 'border-l');
            expenseBtn.dataset.current = 'expense';
            incomeBtn.dataset.current = '';
        }
    }

    // --- VIEW MANAGEMENT LOGIC ---
    function changeView(viewId) {
        activeView = viewId;
        viewContainers.forEach(container => {
            container.classList.add('hidden');
        });
        document.getElementById(`view-${viewId}`).classList.remove('hidden');

        // Dynamic Header Update
        const activeNavButton = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
        if (activeNavButton) {
            getPageTitleEl().textContent = activeNavButton.dataset.name;
        }

        navButtons.forEach(btn => {
            btn.classList.remove('active-nav');
            if (btn.dataset.view === viewId) {
                btn.classList.add('active-nav');
            }
        });
        
        // Ensure charts are redrawn if switching to dashboard or plans are generated
        if (viewId === 'dashboard') {
            setTimeout(() => {
                updateCashFlowChart(generateProjections());
                updateMonthlyNetChart(generateProjections());
            }, 10); 
        } else if (viewId === 'plan') {
            // Recalculate spending plans when entering the view
            const projections = generateProjections();
            const metrics = updateKeyMetrics(projections);
            generateSpendingPlans(metrics); // This is the main plan calculation function
        }
    }
    // --- END VIEW MANAGEMENT LOGIC ---

    // =========================================================================
    // LOCAL STORAGE LOAD DATA (Reverted to pure localStorage)
    // =========================================================================
    function loadData() {
        try {
            // Load and parse all main data arrays
            const savedSchedules = localStorage.getItem('recurringSchedules');
            const savedOneTime = localStorage.getItem('oneTimeTransactions');
            const savedDebtPlans = localStorage.getItem('debtPlans'); 
            const savedBalance = localStorage.getItem('startingBalance');
            const savedProjectionMonths = localStorage.getItem('projectionMonths');
            const savedStartDate = localStorage.getItem('startDate');
            const savedSize = localStorage.getItem('calendarSize');
            
            // NEW: Load EOD Balance preference
            const savedEOD = localStorage.getItem('showEODBalance');
            showEODBalance = savedEOD ? savedEOD === 'true' : false; // Default to false
            if (toggleEODBalanceEl) toggleEODBalanceEl.checked = showEODBalance;
            
            // NEW: Load saved amount and categories
            const savedAmountLS = localStorage.getItem('savedAmount');
            if (savedAmountLS) { savedAmount = parseFloat(savedAmountLS); }
            
            const savedCategories = localStorage.getItem('activeSpendingCategories');
            if (savedCategories) { 
                activeSpendingCategories = JSON.parse(savedCategories); 
            } else {
                 // Initialize categories with defaults if nothing saved
                activeSpendingCategories = SPENDING_CATEGORIES.map(c => ({...c, enabled: c.defaultEnabled}));
            }
            
            recurringSchedules = savedSchedules ? JSON.parse(savedSchedules) : defaultSchedules;
            oneTimeTransactions = savedOneTime ? JSON.parse(savedOneTime) : []; 
            debtPlans = savedDebtPlans ? JSON.parse(savedDebtPlans) : [];       
            
            // Load settings - Map dashboard controls to main element IDs
            if (savedBalance) {
                startingBalanceEl.value = savedBalance;
                if (startingBalanceDashboardEl) startingBalanceDashboardEl.value = savedBalance;
            } else {
                 // Use HTML default if nothing saved
                if (startingBalanceDashboardEl) startingBalanceDashboardEl.value = startingBalanceEl.value; 
            }
            if (savedProjectionMonths) {
                projectionMonthsEl.value = savedProjectionMonths;
                if (projectionMonthsDashboardEl) projectionMonthsDashboardEl.value = savedProjectionMonths;
            }
            if (savedStartDate) {
                 startDateEl.value = savedStartDate;
                 if (startDateDashboardEl) startDateDashboardEl.value = savedStartDate;
            }
            if (savedSize) setCalendarSize(savedSize);

            showStatus('Data loaded from device memory.', 'bg-green-100 text-green-700');
            
        } catch (e) {
            console.error("Error loading data from localStorage:", e);
            // Revert to defaults if loading fails
            recurringSchedules = defaultSchedules;
            oneTimeTransactions = [];
            debtPlans = [];
            activeSpendingCategories = SPENDING_CATEGORIES.map(c => ({...c, enabled: c.defaultEnabled}));
            showStatus('ERROR: Failed to load data from device. Using defaults.', 'bg-red-100 text-red-700');
        }
    }

    // =========================================================================
    // LOCAL STORAGE SAVE DATA (Reverted to pure localStorage)
    // =========================================================================
    function saveData() {
        try {
            // Sync settings between calendar and dashboard input fields before saving
            const balance = startingBalanceEl.value;
            const months = projectionMonthsEl.value;
            const date = startDateEl.value;

            // Save all data arrays
            localStorage.setItem('recurringSchedules', JSON.stringify(recurringSchedules));
            localStorage.setItem('oneTimeTransactions', JSON.stringify(oneTimeTransactions));
            localStorage.setItem('debtPlans', JSON.stringify(debtPlans)); 
            
            // Save all settings
            localStorage.setItem('startingBalance', balance); 
            localStorage.setItem('projectionMonths', months); 
            localStorage.setItem('startDate', date); 
            localStorage.setItem('calendarSize', currentCalendarSize); 
            // NEW: Save EOD Balance preference
            localStorage.setItem('showEODBalance', showEODBalance);
            // NEW: Save saved amount and categories status
            localStorage.setItem('savedAmount', savedAmount.toFixed(2));
            localStorage.setItem('activeSpendingCategories', JSON.stringify(activeSpendingCategories));
            
            showStatus('Settings and Data saved successfully to device memory!', 'bg-blue-100 text-blue-700');
        } catch (e) {
            console.error("Error saving data to localStorage:", e);
            showStatus('ERROR: Could not save data. Check browser settings (incognito mode).', 'bg-red-100 text-red-700');
        }
    }
    
    function saveAndRender() {
        saveData();
        renderSchedules();
        renderDebtPlans(); 
        updateDashboard();
    }
    
    function renderDebtPlans() {
        debtPlansListEl.innerHTML = '';
        debtPlans.forEach(plan => {
            const monthly = (plan.totalAmount / plan.payoffMonths).toFixed(2);
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 rounded-xl border border-pink-200 bg-white shadow-sm hover:shadow-md transition';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mr-4 bg-pink-500"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${plan.name}</p>
                        <p class="text-sm text-gray-500">Total: $${plan.totalAmount.toLocaleString()} | Payoff: ${plan.payoffMonths} months</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p class="font-bold text-lg text-pink-600 w-24 text-right">
                        $${monthly}
                    </p>
                    <div class="flex space-x-1">
                        <button type="button" class="debt-edit-btn p-2 text-gray-500 hover:text-pink-600 rounded-full hover:bg-gray-100" data-id="${plan.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="debt-delete-btn p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100" data-id="${plan.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            debtPlansListEl.appendChild(item);
        });
    }

    function renderSchedules() {
        schedulesListEl.innerHTML = '';
        recurringSchedules.forEach(schedule => {
            const isExpense = schedule.amount < 0;
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 rounded-xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mr-4 ${isExpense ? 'bg-red-500' : 'bg-green-500'}"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${schedule.name}</p>
                        <p class="text-sm text-gray-500">${isExpense ? 'Expense' : 'Income'}: ${schedule.frequency}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p class="font-semibold text-lg ${isExpense ? 'text-red-600' : 'text-green-600'} w-24 text-right">
                        $${Math.abs(schedule.amount).toFixed(2)}
                    </p>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" name="toggle" id="toggle-${schedule.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${schedule.enabled ? 'checked' : ''} data-id="${schedule.id}"/>
                        <label for="toggle-${schedule.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <div class="flex space-x-1">
                        <button type="button" class="edit-btn p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100" data-id="${schedule.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="delete-btn p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100" data-id="${schedule.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            schedulesListEl.appendChild(item);
        });
    }

    function addEventListeners() {
        // Navigation Listener
        navButtons.forEach(btn => btn.addEventListener('click', (e) => {
            changeView(e.currentTarget.dataset.view);
        }));
        
        // Listener for calendar size buttons
        calendarSizeButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                setCalendarSize(e.target.dataset.size);
                updateDashboard();
            });
        });

        // NOTE: All handlers call updateDashboard, which calls saveAndRender, which calls saveData.
        // Sync inputs and trigger dashboard update/save
        [startDateEl, projectionMonthsEl, startingBalanceEl].forEach(el => el.addEventListener('change', (e) => {
            // Sync calendar inputs to dashboard controls
            if (startDateDashboardEl) startDateDashboardEl.value = startDateEl.value;
            if (projectionMonthsDashboardEl) projectionMonthsDashboardEl.value = projectionMonthsEl.value;
            if (startingBalanceDashboardEl) startingBalanceDashboardEl.value = startingBalanceEl.value;
            updateDashboard();
        }));
        
        // Sync inputs from dashboard controls to calendar fields
        [startDateDashboardEl, projectionMonthsDashboardEl, startingBalanceDashboardEl].forEach(el => el.addEventListener('change', (e) => {
            if (startDateEl) startDateEl.value = startDateDashboardEl.value;
            if (projectionMonthsEl) projectionMonthsEl.value = projectionMonthsDashboardEl.value;
            if (startingBalanceEl) startingBalanceEl.value = startingBalanceDashboardEl.value;
            updateDashboard();
        }));
        
        // Manual Save Button Listener (Calendar & Dashboard versions)
        manualSaveBtn.addEventListener('click', () => {
            updateDashboard(); // Triggers full recalculate and saveData()
        });
        document.getElementById('manual-save-btn-dashboard').addEventListener('click', () => {
            updateDashboard(); // Triggers full recalculate and saveData()
        });
        
        // Listeners for type toggles (One-Time)
        document.getElementById('onetime-type-toggle').addEventListener('click', (e) => {
            if (e.target.dataset.type) {
                setToggleVisuals('onetime-type-toggle', e.target.dataset.type);
            }
        });

        // Listeners for type toggles (Recurring)
        document.getElementById('schedule-type-toggle').addEventListener('click', (e) => {
            if (e.target.dataset.type) {
                setToggleVisuals('schedule-type-toggle', e.target.dataset.type);
            }
        });
        
        // --- DEBT PLAN EVENT LISTENERS ---
        debtPlansListEl.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.debt-edit-btn');
            const deleteBtn = e.target.closest('.debt-delete-btn');

            if (editBtn) {
                openDebtPlanModal(debtPlans.find(p => p.id === editBtn.dataset.id));
            } else if (deleteBtn) {
                if(confirm('Are you sure you want to delete this debt plan?')) {
                    debtPlans = debtPlans.filter(p => p.id !== deleteBtn.dataset.id);
                    saveAndRender();
                }
            }
        });

        document.getElementById('add-debt-plan-btn').addEventListener('click', () => openDebtPlanModal());
        document.querySelector('.cancel-btn-debt').addEventListener('click', () => closeModal(debtPlanModal));

        debtPlanForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = debtIdInput.value;
            const totalAmount = parseFloat(document.getElementById('total-amount').value);
            const payoffMonths = parseInt(document.getElementById('payoff-months').value);
            
            const newDebtPlan = {
                id: id || `DEBT-${Date.now()}`,
                name: document.getElementById('debt-name').value,
                totalAmount: totalAmount,
                payoffMonths: payoffMonths,
                monthlyPayment: parseFloat((totalAmount / payoffMonths).toFixed(2)),
                payDay: parseInt(format(parseISO(document.getElementById('debt-start-date').value), 'd')),
                startDate: document.getElementById('debt-start-date').value,
                enabled: true
            };

            if (id) {
                const index = debtPlans.findIndex(p => p.id === id);
                debtPlans[index] = newDebtPlan;
            } else {
                debtPlans.push(newDebtPlan);
            }
            closeModal(debtPlanModal);
            saveAndRender();
        });
        // --- END DEBT PLAN EVENT LISTENERS ---

        // Recurring Schedule Event Listeners
        schedulesListEl.addEventListener('click', (e) => {
            const toggle = e.target.closest('.toggle-checkbox');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (toggle) {
                const schedule = recurringSchedules.find(s => s.id === toggle.dataset.id);
                if (schedule) {
                    schedule.enabled = toggle.checked;
                    saveAndRender();
                }
            } else if (editBtn) {
                openRecurringModal(recurringSchedules.find(s => s.id === editBtn.dataset.id));
            } else if (deleteBtn) {
                if(confirm('Are you sure you want to delete this recurring schedule?')) {
                    recurringSchedules = recurringSchedules.filter(s => s.id !== deleteBtn.dataset.id);
                    saveAndRender();
                }
            }
        });

        document.getElementById('add-schedule-btn').addEventListener('click', () => openRecurringModal());
        document.getElementById('add-one-time-btn').addEventListener('click', () => openOneTimeModal());
        
        // Cancel buttons for all modals
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => {
            closeModal(scheduleModal);
            closeModal(oneTimeModal);
        }));
        document.getElementById('close-day-details-btn').addEventListener('click', () => closeModal(dayDetailsModal)); // NEW close button listener

        // MODAL ADD ONE-TIME EVENT LISTENER (NEW)
        document.getElementById('add-from-day-details').addEventListener('click', (e) => {
            const dateKey = e.currentTarget.dataset.date;
            closeModal(dayDetailsModal); // Close the detail modal
            
            // Open the one-time modal, passing the specific date string
            openOneTimeModal(null, dateKey); 
        });

        // Modal close on backdrop click
        scheduleModal.addEventListener('click', (e) => { if (e.target === scheduleModal) closeModal(scheduleModal); });
        oneTimeModal.addEventListener('click', (e) => { if (e.target === oneTimeModal) closeModal(oneTimeModal); });
        debtPlanModal.addEventListener('click', (e) => { if (e.target === debtPlanModal) closeModal(debtPlanModal); }); 
        dayDetailsModal.addEventListener('click', (e) => { if (e.target === dayDetailsModal) closeModal(dayDetailsModal); }); 
        
        // Spending Plan: Apply Plan
        planButtonsEl.addEventListener('click', (e) => {
            const button = e.target.closest('.apply-plan-btn');
            if (button) {
                const planData = JSON.parse(button.dataset.plan);
                applySpendingPlan(planData);
            }
        });

        // Submit Recurring Schedule
        scheduleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = scheduleIdInput.value;
            const rawAmount = parseFloat(document.getElementById('amount').value);
            const isIncome = document.querySelector('#schedule-type-toggle [data-current="income"]');
            const finalAmount = isIncome ? rawAmount : -rawAmount; // Apply sign based on toggle

            const newSchedule = {
                id: id || `SCH-${Date.now()}`,
                name: document.getElementById('name').value,
                amount: finalAmount, // Use signed amount
                startDate: document.getElementById('start_date').value,
                frequency: frequencySelect.value,
                dayValue: frequencySelect.value === 'Monthly' ? parseInt(document.getElementById('day_value_month').value) : document.getElementById('day_value_week').value,
                enabled: true
            };

            if (id) {
                const index = recurringSchedules.findIndex(s => s.id === id);
                newSchedule.enabled = recurringSchedules[index].enabled;
                recurringSchedules[index] = newSchedule;
            } else {
                recurringSchedules.push(newSchedule);
            }
            closeModal(scheduleModal);
            saveAndRender();
        });

        // Submit One-Time Transaction (UPDATED TO HANDLE EDITING)
        oneTimeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('onetime-id').value; // Get ID for editing
            const rawAmount = parseFloat(document.getElementById('onetime-amount').value);
            const isIncome = document.querySelector('#onetime-type-toggle [data-current="income"]');
            const finalAmount = isIncome ? rawAmount : -rawAmount; // Apply sign based on toggle
            
            const newTransaction = {
                id: id || `ONE-${Date.now()}`,
                name: document.getElementById('onetime-name').value,
                amount: finalAmount, // Use signed amount
                date: document.getElementById('onetime-date').value,
            };

            if (id) {
                // Editing existing transaction
                const index = oneTimeTransactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    oneTimeTransactions[index] = newTransaction;
                }
            } else {
                // Adding new
                oneTimeTransactions.push(newTransaction);
            }
            
            closeModal(oneTimeModal);
            saveAndRender();
        });

        frequencySelect.addEventListener('change', toggleDayValueInputs);

        document.getElementById('prev-month').addEventListener('click', () => {
            currentCalendarDate = subMonths(currentCalendarDate, 1);
            updateDashboard(); 
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentCalendarDate = addMonths(currentCalendarDate, 1);
            updateDashboard(); 
        });
        
        // Listener for clicking on calendar days
        document.getElementById('calendar-grid').addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl && dayEl.dataset.date) {
                openDayDetailsModal(dayEl.dataset.date);
            }
        });
        
        // FIX: Listener for buttons within the Day Details Modal
        document.getElementById('day-details-list').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-onetime-btn');
            const editBtn = e.target.closest('.edit-onetime-btn');
            
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const transactionToDelete = oneTimeTransactions.find(t => t.id === id);

                if (transactionToDelete && confirm(`Are you sure you want to delete the one-time event: "${transactionToDelete.name}"?`)) {
                    oneTimeTransactions = oneTimeTransactions.filter(t => t.id !== id);
                    closeModal(dayDetailsModal); // Close the detail modal after action
                    saveAndRender();
                } else if (!transactionToDelete) {
                     console.error(`Attempted to delete one-time transaction with ID ${id}, but it was not found.`);
                }
            } else if (editBtn) {
                const id = editBtn.dataset.id;
                // Find the transaction object using the ID
                const transactionToEdit = oneTimeTransactions.find(t => t.id === id);
                if (transactionToEdit) {
                    closeModal(dayDetailsModal); // Close details modal
                    openOneTimeModal(transactionToEdit); // Open edit modal
                }
            }
        });
        
        // --- NEW PLAN LISTENERS ---
        
        // Savings Slider Listener
        savingsSliderEl.addEventListener('input', (e) => {
            savedAmount = parseFloat(e.target.value);
            // Update the slider track progress for visual feedback
            const max = parseFloat(savingsSliderEl.max);
            const percentage = (max > 0) ? (savedAmount / max) * 100 : 0;
            savingsSliderEl.style.setProperty('--slider-progress', `${percentage}%`);
            savedAmountDisplayEl.textContent = `$${savedAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            updateDashboard(); // Recalculate everything based on new saved amount
        });
        
        // Delete Plan Listener
        deletePlanBtnEl.addEventListener('click', () => {
            if (confirm('Are you sure you want to DELETE the current spending plan (all transactions tagged "(Planned)")?')) {
                // Filter out all one-time transactions that were generated by the plan
                oneTimeTransactions = oneTimeTransactions.filter(t => !t.name.includes('(Planned)'));
                showStatus('All planned spending transactions deleted.', 'bg-red-100 text-red-700');
                saveAndRender();
            }
        });
        
        // Category Toggle Listener
        categoryTogglesEl.addEventListener('click', (e) => {
            const toggle = e.target.closest('input[type="checkbox"]');
            if (toggle) {
                const categoryName = toggle.dataset.category;
                const isChecked = toggle.checked;

                const categoryIndex = activeSpendingCategories.findIndex(c => c.name === categoryName);
                if (categoryIndex !== -1) {
                    activeSpendingCategories[categoryIndex].enabled = isChecked;
                    updateDashboard(); // Recalculate plan and metrics
                }
            }
        });
        
        // EOD Balance Toggle Listener (NEW)
        if (toggleEODBalanceEl) {
            toggleEODBalanceEl.addEventListener('change', (e) => {
                showEODBalance = e.target.checked;
                updateDashboard(); // Redraw calendar
            });
        }
        
        // --- END NEW PLAN LISTENERS ---
    }
    
    // Updates the Recurring Schedule Modal (for editing)
    function openRecurringModal(schedule = null) {
        scheduleForm.reset();
        let type = 'expense';
        let amountValue = '';

        if (schedule) {
            document.getElementById('modal-title').textContent = 'Edit Recurring Schedule';
            scheduleIdInput.value = schedule.id;
            document.getElementById('name').value = schedule.name;
            
            amountValue = Math.abs(schedule.amount);
            type = schedule.amount > 0 ? 'income' : 'expense';

            document.getElementById('start_date').value = schedule.startDate;
            frequencySelect.value = schedule.frequency;
            if (document.getElementById('day_value_month')) document.getElementById('day_value_month').value = schedule.dayValue;
            if (document.getElementById('day_value_week')) document.getElementById('day_value_week').value = schedule.dayValue;
        } else {
            document.getElementById('modal-title').textContent = 'Add New Recurring Schedule';
            scheduleIdInput.value = '';
        }
        
        document.getElementById('amount').value = amountValue || '';
        setToggleVisuals('schedule-type-toggle', type); // Set initial visual state
        toggleDayValueInputs();
        scheduleModal.classList.remove('modal-inactive');
        scheduleModal.classList.add('modal-active');
    }

    // Updates the One-Time Transaction Modal (for adding/editing)
    // ADDED dateKey parameter for pre-filling date from calendar click
    function openOneTimeModal(transaction = null, dateKey = null) { 
        oneTimeForm.reset();
        document.getElementById('onetime-id').value = ''; // Clear ID default
        let type = 'expense';
        let amountValue = '';
        // Default date to set: either the passed dateKey or the current calendar date
        let dateToSet = dateKey || format(currentCalendarDate, 'yyyy-MM-dd'); 

        if (transaction) {
            // Editing existing transaction
            document.getElementById('onetime-id').value = transaction.id;
            document.getElementById('onetime-name').value = transaction.name;
            
            amountValue = Math.abs(transaction.amount);
            type = transaction.amount > 0 ? 'income' : 'expense';
            
            // Use transaction date for input field when editing
            dateToSet = format(parseISO(transaction.date), 'yyyy-MM-dd'); 
        }
        
        document.getElementById('onetime-date').value = dateToSet;
        document.getElementById('onetime-amount').value = amountValue || '';
        setToggleVisuals('onetime-type-toggle', type); // Default to expense
        oneTimeModal.classList.remove('modal-inactive');
        oneTimeModal.classList.add('modal-active');
    }

    function openDebtPlanModal(plan = null) {
        debtPlanForm.reset();
        document.getElementById('debt-pay-day').value = 1; 
        if (plan) {
            document.getElementById('debt-modal-title').textContent = 'Edit Debt Plan';
            debtIdInput.value = plan.id;
            document.getElementById('debt-name').value = plan.name;
            document.getElementById('total-amount').value = plan.totalAmount;
            document.getElementById('payoff-months').value = plan.payoffMonths;
            document.getElementById('debt-start-date').value = plan.startDate;
            document.getElementById('debt-pay-day').value = plan.payDay;
        } else {
            document.getElementById('debt-modal-title').textContent = 'Add New Debt Plan';
            debtIdInput.value = '';
            document.getElementById('debt-start-date').value = format(new Date(), 'yyyy-MM-dd');
        }
        debtPlanModal.classList.remove('modal-inactive');
        debtPlanModal.classList.add('modal-active');
    }
    
    function closeModal(el) {
        el.classList.add('modal-inactive');
        el.classList.remove('modal-active');
    }

    function toggleDayValueInputs() {
        if (frequencySelect.value === 'Monthly') {
            document.getElementById('day-value-monthly').classList.remove('hidden');
            document.getElementById('day-value-weekly').classList.add('hidden');
            document.getElementById('day_value_month').required = true;
            document.getElementById('day_value_week').required = false;
        } else if (frequencySelect.value === 'Weekly' || frequencySelect.value === 'BiWeekly') { // UPDATED FOR BI-WEEKLY
            document.getElementById('day-value-monthly').classList.add('hidden');
            document.getElementById('day-value-weekly').classList.remove('hidden');
            document.getElementById('day_value_month').required = false;
            document.getElementById('day_value_week').required = true;
        } else {
             document.getElementById('day-value-monthly').classList.add('hidden');
             document.getElementById('day-value-weekly').classList.add('hidden');
             document.getElementById('day_value_month').required = false;
             document.getElementById('day_value_week').required = false;
        }
    }
    
    // NEW HELPER FUNCTION: Finds the EOD balance for any given date key, even if it's empty
    function getEndOfDayBalance(dateKey) {
        const startingBalance = parseFloat(startingBalanceEl.value) || 0;
        
        // 1. Check if the balance is directly available (i.e., day had transactions)
        if (dailyBalanceMap[dateKey] !== undefined) {
            return dailyBalanceMap[dateKey];
        }

        // 2. If not, look backward for the most recent transaction day's balance
        let currentDate = parseISO(dateKey);
        const projectionStartDate = parseISO(startDateEl.value);

        // Iterate backwards from the day before the target date
        let lookBackDate = subDays(currentDate, 1);
        
        while (lookBackDate >= projectionStartDate) {
            const lookBackKey = format(lookBackDate, 'yyyy-MM-dd');
            if (dailyBalanceMap[lookBackKey] !== undefined) {
                return dailyBalanceMap[lookBackKey]; // Found the balance from the most recent transaction day
            }
            lookBackDate = subDays(lookBackDate, 1);
        }

        // 3. If no transaction day was found before the target date, return the starting balance
        return startingBalance;
    }

    // FUNCTION: Opens the modal showing transactions for the selected day
    function openDayDetailsModal(dateKey) {
        const transactions = dailyTransactionMap[dateKey] || [];
        
        // FIX: Use the new robust lookup function
        const rawFinalBalance = getEndOfDayBalance(dateKey); 
        
        const finalBalanceText = `$${rawFinalBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
        const titleEl = document.getElementById('day-details-title');
        const listEl = document.getElementById('day-details-list');
        const addOneTimeBtn = document.getElementById('add-from-day-details'); // NEW BUTTON ELEMENT

        // NEW: Include the End of Day Balance in the title
        titleEl.innerHTML = `Transactions on ${format(parseISO(dateKey), 'EEEE, MMM do')}
                             <span class="block text-base font-medium text-gray-600 mt-1">End of Day Balance: <span class="font-bold text-lg text-blue-600">${finalBalanceText}</span></span>`;
        listEl.innerHTML = '';
        
        if (transactions.length === 0) {
             listEl.innerHTML = `<p class="text-center text-gray-500 italic">No scheduled transactions for this day.</p>`;
        }
        
        transactions.forEach(t => {
            const isExpense = t.amount < 0;
            let colorClass = isExpense ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800';
            let amountClass = isExpense ? 'text-red-600' : 'text-green-600';
            let icon = isExpense ? '↓' : '↑';
            let typeLabel = t.type === 'Debt Payment' ? 'Debt' : t.type === 'One-Time' ? 'One-Time' : 'Recurring';
            
            const item = document.createElement('div');
            item.className = `flex justify-between items-center p-3 rounded-lg border ${colorClass}`;
            
            // --- FIX: Allow editing/deleting of all One-Time events (including Planned) ---
            let controlsHTML = '';
            if (t.type === 'One-Time') { 
                 controlsHTML = `
                    <div class="flex space-x-2 items-center">
                        <button type="button" class="edit-onetime-btn text-gray-500 hover:text-purple-600 p-1 rounded-full hover:bg-gray-100" data-id="${t.id}" title="Edit Transaction">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="delete-onetime-btn text-gray-500 hover:text-red-600 p-1 rounded-full hover:bg-gray-100" data-id="${t.id}" title="Delete Transaction">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            }
            // --- END FIX ---

            item.innerHTML = `
                <div class="flex flex-col flex-grow">
                    <span class="font-medium text-gray-800">${t.name}</span>
                    <span class="text-xs text-gray-500">${typeLabel}</span>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="font-bold text-lg ${amountClass}">${icon} $${Math.abs(t.amount).toFixed(2)}</span>
                    ${controlsHTML}
                </div>
            `;
            listEl.appendChild(item);
        });
        
        // NEW: Set the date on the "Add One-Time Event" button
        addOneTimeBtn.dataset.date = dateKey;

        dayDetailsModal.classList.remove('modal-inactive');
        dayDetailsModal.classList.add('modal-active');
    }

    // NEW FUNCTION: Calculates the running balance for every projected transaction date
    function calculateDailyBalances(projections) {
        let runningBalance = parseFloat(startingBalanceEl.value);
        dailyBalanceMap = {}; // Reset map

        // Note: The projections array is already sorted by date.

        projections.forEach(t => {
            runningBalance += t.amount;
            const dateKey = format(t.date, 'yyyy-MM-dd');
            
            // Always record the balance after the transaction
            dailyBalanceMap[dateKey] = runningBalance;
        });
    }


    function generateProjections() {
        const startDate = new Date(startDateEl.value + 'T00:00:00');
        const months = parseInt(projectionMonthsEl.value);
        const endDate = addMonths(startDate, months);
        const activeSchedules = recurringSchedules.filter(s => s.enabled);
        let projections = [];
        
        // 1. Generate Recurring Projections
        const intervalDays = eachDayOfInterval({ start: startDate, end: endDate });
        intervalDays.forEach(day => {
            activeSchedules.forEach(schedule => {
                if (day < new Date(schedule.startDate + 'T00:00:00')) return;

                let shouldPay = false;
                const scheduleStart = parseISO(schedule.startDate);

                if (schedule.frequency === 'Monthly' && getDate(day) === schedule.dayValue) {
                    shouldPay = true;
                } else if (schedule.frequency === 'Weekly' && getDay(day) === weeklyDayMap[schedule.dayValue]) {
                    shouldPay = true;
                } else if (schedule.frequency === 'BiWeekly' && getDay(day) === weeklyDayMap[schedule.dayValue]) {
                    // Check if the number of days elapsed since the start date is a multiple of 14
                    const daysSinceStart = (day.getTime() - scheduleStart.getTime()) / (1000 * 60 * 60 * 24);
                    // Use a small margin (e.g., 0.5 day) for float point safety near 0
                    if (daysSinceStart >= -0.5 && Math.abs(daysSinceStart % 14) < 0.5) { 
                        shouldPay = true;
                    }
                }

                if (shouldPay) {
                    projections.push({ date: day, name: schedule.name, amount: schedule.amount, type: 'Recurring' });
                }
            });
        });

        // 2. Add Debt Plan Payments
        debtPlans.forEach(plan => { 
            let paymentsMade = 0;
            
            let currentMonth = startOfMonth(startDate);
            while (currentMonth <= endDate && paymentsMade < plan.payoffMonths) {
                const day = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), plan.payDay);

                if (day >= startDate && day <= endDate && day >= parseISO(plan.startDate)) {
                    projections.push({ 
                        date: day, 
                        name: `Debt Payment: ${plan.name}`, 
                        amount: -plan.monthlyPayment, 
                        type: 'Debt Payment' 
                    });
                    paymentsMade++;
                }
                currentMonth = addMonths(currentMonth, 1);
            }
        });


        // 3. Add One-Time Transactions
        oneTimeTransactions.forEach(t => {
            const tDate = new Date(t.date + 'T00:00:00');
            if (tDate >= startDate && tDate <= endDate) {
                projections.push({ date: tDate, name: t.name, amount: t.amount, type: 'One-Time', id: t.id }); // Ensure ID is passed
            }
        });

        return projections.sort((a, b) => a.date - b.date);
    }
    
    function updateDashboard() {
        const projections = generateProjections();
        calculateDailyBalances(projections); // NEW CALL
        const metrics = updateKeyMetrics(projections); // Store metrics for plan view
        
        // Sync the dashboard settings fields with the main calendar settings fields
        if (startDateDashboardEl) startDateDashboardEl.value = startDateEl.value;
        if (projectionMonthsDashboardEl) projectionMonthsDashboardEl.value = projectionMonthsEl.value;
        if (startingBalanceDashboardEl) startingBalanceDashboardEl.value = startingBalanceEl.value;
        
        // Update plan view data
        if (activeView === 'plan' || document.getElementById('view-plan').classList.contains('hidden') === false) {
             generateSpendingPlans(metrics);
        }

        // Only call chart updates if the dashboard view is active or immediately after controls change
        if (activeView === 'dashboard') {
            updateCashFlowChart(generateProjections());
            updateMonthlyNetChart(generateProjections());
        }
        renderCalendar(projections);
        renderTransactionTable(projections);
        saveData(); // Save ALL settings and data after a successful dashboard update
    }

    function renderCalendar(projections) {
        const calendarGrid = document.getElementById('calendar-grid');
        document.getElementById('calendar-month-year').textContent = format(currentCalendarDate, 'MMMM yyyy');
        calendarGrid.innerHTML = '';
        const monthStart = startOfMonth(currentCalendarDate);
        const monthEnd = endOfMonth(currentCalendarDate);
        const startDate = startOfWeek(monthStart);
        const endDate = endOfWeek(monthEnd);
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        dailyTransactionMap = {}; // Clear map for the new month
        
        // Render Day Headers
        days.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = "text-center font-semibold text-sm text-gray-600 py-2";
            dayEl.textContent = day;
            calendarGrid.appendChild(dayEl);
        });
        
        let day = startDate;
        while(day <= endDate) {
            const dateKey = format(day, 'yyyy-MM-dd');
            const dailyTransactions = projections.filter(p => format(p.date, 'yyyy-MM-dd') === dateKey);
            const inCurrentMonth = isSameMonth(day, monthStart); // NEW: Check if day is in current month

            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day p-2 border border-gray-200 rounded-md ${!inCurrentMonth ? 'bg-gray-50 text-gray-400' : 'bg-white'}`;
            if (isToday(day)) { dayEl.classList.add('border-blue-500', 'border-2'); }
            
            // 1. Element for the Day Number (Date)
            const dateNumberEl = document.createElement('div');
            // Using flex-col here to handle stacking for smaller sizes
            dateNumberEl.className = "text-sm font-semibold text-right flex flex-col items-end"; 
            
            // Append the date number
            const dateSpan = document.createElement('span');
            dateSpan.textContent = format(day, 'd');
            dateNumberEl.appendChild(dateSpan);
            
            // 2. --- NEW: Add EOD Balance Display (Stacked Below Date) ---
            if (showEODBalance && inCurrentMonth) {
                const eodBalance = getEndOfDayBalance(dateKey);
                const balanceDisplay = document.createElement('div'); // Changed to div for block-level stacking
                
                // Determine color for the balance based on overall EOD value
                let balanceColor = 'text-gray-500';
                if (eodBalance >= 1000) balanceColor = 'text-green-600';
                else if (eodBalance < 0) balanceColor = 'text-red-600';

                // Display the End of Day balance concisely (rounded to the nearest k)
                const roundedEOD = Math.round(eodBalance / 100) / 10; // Round to 0.1k
                
                // FIX: Removed ml-1 and $ sign
                balanceDisplay.className = `text-xs font-bold ${balanceColor} text-right leading-none truncate`;
                balanceDisplay.textContent = `${roundedEOD.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}k`; 
                
                balanceDisplay.title = `End of Day: $${eodBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                dateNumberEl.appendChild(balanceDisplay); // Append balance as child of dateNumberEl
            }
            // --- END NEW EOD Balance Display ---
            
            dayEl.appendChild(dateNumberEl); // Append the date container

            if (inCurrentMonth) {
                // FIX: Make ALL days in the current month interactive
                dayEl.dataset.date = dateKey;
                dayEl.classList.add('cursor-pointer', 'hover:shadow-lg'); 
                
                if (dailyTransactions.length > 0) {
                    dailyTransactionMap[dateKey] = dailyTransactions;
                    dayEl.classList.add('bg-blue-50'); // Highlight if transactions exist
                }
            }

            
            const transactionList = document.createElement('ul');
            transactionList.className = 'mt-1 space-y-1 text-xs overflow-y-auto'
            dailyTransactions.forEach(t => {
                let colorClass;
                let borderClass = '';
                if (t.type === 'Debt Payment') {
                    colorClass = 'bg-pink-100 text-pink-800';
                    borderClass = 'border-l-2 border-pink-500';
                } else if (t.type === 'One-Time') {
                    // Check if it's a planned expense (purple)
                    colorClass = t.name.includes('(Planned)') ? 'bg-purple-50 text-purple-800' : (t.amount > 0 ? 'bg-purple-100 text-purple-800' : 'bg-red-100 text-red-800');
                    borderClass = 'border-l-2 border-purple-500';
                } else if (t.amount > 0) {
                    colorClass = 'bg-green-100 text-green-800';
                } else {
                    colorClass = 'bg-red-100 text-red-800';
                }
                
                const li = document.createElement('li');
                li.className = `flex items-center p-1 rounded ${colorClass} ${borderClass}`;
                li.innerHTML = `<span class="truncate" title="${t.name}">${t.name}</span> <span class="font-semibold ml-auto">$${Math.abs(t.amount).toFixed(0)}</span>`;
                transactionList.appendChild(li);
            });
            dayEl.appendChild(transactionList);
            calendarGrid.appendChild(dayEl);
            day = addDays(day, 1);
        }
    }

    function updateKeyMetrics(projections) {
        const startingBalance = parseFloat(startingBalanceEl.value || startingBalanceDashboardEl.value);
        let totalIncome = 0;
        let totalExpenses = 0;
        projections.forEach(p => {
            if (p.amount > 0) totalIncome += p.amount;
            else totalExpenses += p.amount;
        });
        const endBalance = startingBalance + totalIncome + totalExpenses;

        document.getElementById('endBalance').textContent = `$${endBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalExpenses').textContent = `$${Math.abs(totalExpenses).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        return { totalIncome, totalExpenses, endBalance, startingBalance };
    }

    function renderTransactionTable(projections) {
        const tableBody = document.getElementById('transactionTableBody');
        tableBody.innerHTML = '';
        const filter = transactionFilterEl.value;
        const filtered = projections.filter(p => {
            if (filter === 'all') return true;
            if (filter === 'income') return p.amount > 0;
            // Treat debt payments and normal expenses as 'expense' for this filter
            if (filter === 'expense') return p.amount < 0; 
        });

        if (filtered.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500">No transactions for this period.</td></tr>`;
            return;
        }

        filtered.forEach(p => {
            const row = tableBody.insertRow();
            let typeLabel;
            let amountClass;
            
            if (p.type === 'Debt Payment') {
                typeLabel = 'Debt';
                amountClass = 'text-pink-600';
            } else if (p.type === 'One-Time') {
                typeLabel = p.name.includes('(Planned)') ? 'PLAN' : 'One-Time';
                amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
            } else {
                typeLabel = 'Recurring';
                amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${format(p.date, 'MMM dd, yyyy')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${p.name} <span class="text-xs text-gray-400">(${typeLabel})</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${amountClass}">${p.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
            `;
        });
    }

    function updateCashFlowChart(projections) {
        const ctx = document.getElementById('cashFlowChart').getContext('2d');
        const startingBalance = parseFloat(startingBalanceEl.value);
        let currentBalance = startingBalance;
        
        const dataPoints = [{ x: new Date(startDateEl.value + 'T00:00:00'), y: startingBalance }];
        projections.forEach(p => {
            currentBalance += p.amount;
            dataPoints.push({ x: p.date, y: currentBalance });
        });

        if (cashFlowChart) cashFlowChart.destroy();
        cashFlowChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Projected Balance',
                    data: dataPoints,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'month' } },
                    y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } }
                },
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: (context) => ` Balance: ${context.formattedValue}`
                        }
                    }
                }
            }
        });
    }
    
    function updateMonthlyNetChart(projections) {
        const ctx = document.getElementById('monthlyNetChart').getContext('2d');
        const monthlyData = {};
        projections.forEach(p => {
            const month = format(p.date, 'yyyy-MM');
            if (!monthlyData[month]) monthlyData[month] = 0;
            monthlyData[month] += p.amount;
        });

        const labels = Object.keys(monthlyData).sort();
        const data = labels.map(label => monthlyData[label]);

        if (monthlyNetChart) monthlyNetChart.destroy();
        monthlyNetChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => format(new Date(l + '-02T00:00:00'), 'MMM yyyy')),
                datasets: [{
                    label: 'Net Monthly Flow',
                    data: data,
                    backgroundColor: data.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.7)' : 'rgba(220, 38, 38, 0.7)'),
                    borderColor: data.map(v => v >= 0 ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } } }
            }
        });
    }
    
    // =========================================================================
    // SPENDING PLAN LOGIC 
    // =========================================================================
    
    // Helper: Calculate total weeks in the projection period
    function calculateTotalWeeks(startDate, projectionMonths) {
        const start = parseISO(startDate);
        const end = addMonths(start, projectionMonths);
        let weeks = 0;
        let currentWeekStart = startOfISOWeek(start);

        while (isBefore(currentWeekStart, end)) {
            weeks++;
            currentWeekStart = addDays(currentWeekStart, 7);
        }
        return weeks;
    }
    
    function renderCategoryToggles(categories) {
        categoryTogglesEl.innerHTML = '';
        categories.forEach(cat => {
            const info = cat.fixedWeeklyAmount > 0 
                ? `($${cat.fixedWeeklyAmount.toFixed(2)} Fixed/Week)` 
                : `(${cat.percentage}% Allocation)`;

            const item = document.createElement('div');
            item.className = 'flex items-center space-x-3 p-3 bg-gray-100 rounded-lg';
            item.innerHTML = `
                <input type="checkbox" id="toggle-${cat.name.replace(/\s/g, '-')}" data-category="${cat.name}" ${cat.enabled ? 'checked' : ''} class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                <label for="toggle-${cat.name.replace(/\s/g, '-')}" class="text-sm font-medium text-gray-900 cursor-pointer flex-grow">
                    ${cat.name} <span class="text-xs text-gray-500">${info}</span>
                </label>
            `;
            categoryTogglesEl.appendChild(item);
        });
    }
    
    function generateSpendingPlans(metrics) {
        const totalSavings = metrics.endBalance - metrics.startingBalance;
        const projectionMonths = parseInt(projectionMonthsEl.value);
        const startDate = startDateEl.value;
        const totalWeeks = calculateTotalWeeks(startDate, projectionMonths);

        document.getElementById('savings-projection').textContent = `$${totalSavings.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // 1. Set Slider Max
        const sliderMax = Math.max(0, Math.floor(totalSavings / 100) * 100); // Round down to nearest 100
        savingsSliderEl.max = sliderMax.toFixed(0); 
        savingsSliderEl.value = Math.min(savedAmount, sliderMax).toFixed(0); // Ensure current value doesn't exceed new max
        savedAmount = parseFloat(savingsSliderEl.value); // Re-sync savedAmount
        
        // Update slider progress visual
        const percentage = (sliderMax > 0) ? (savedAmount / sliderMax) * 100 : 0;
        savingsSliderEl.style.setProperty('--slider-progress', `${percentage}%`);
        savedAmountDisplayEl.textContent = `$${savedAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

        // 2. Calculate Remaining Budget
        const remainingBudget = totalSavings - savedAmount;
        
        if (remainingBudget <= 0) {
            remainingBudgetBaseEl.textContent = '$0.00';
            planButtonsEl.innerHTML = `<p class="text-red-500 font-semibold p-4 bg-red-100 rounded-lg">Warning: Your selected savings goal ($${savedAmount.toLocaleString()}) exceeds or equals the projected surplus. No budget available for spending plans.</p>`;
            renderCategoryToggles(activeSpendingCategories); // Render toggles even if no budget
            return;
        }

        const baseWeeklyBudget = remainingBudget / totalWeeks;
        remainingBudgetBaseEl.textContent = `$${remainingBudget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        // NEW LOGIC: Plan margins based on the *remaining* budget
        const planDefinitions = [
            // Plan 1: Spends 100% of the remaining budget (0% savings of remainder) -> Aggressive Spending
            { name: 'Aggressive Spending (100% Budget)', margin: 1.00, buttonClass: 'bg-red-600 hover:bg-red-700' }, 
            // Plan 2: Spends 75% of the remaining budget (25% savings of remainder) -> Balanced Spending
            { name: 'Balanced Spending (75% Budget)', margin: 0.75, buttonClass: 'bg-blue-600 hover:bg-blue-700' },    
            // Plan 3: Spends 50% of the remaining budget (50% savings of remainder) -> Conservative Spending
            { name: 'Conservative Spending (50% Budget)', margin: 0.50, buttonClass: 'bg-green-600 hover:bg-green-700' } 
        ];

        planButtonsEl.innerHTML = '';
        
        const enabledCategories = activeSpendingCategories.filter(c => c.enabled);
        
        // Calculate total weekly fixed costs (e.g., Transportation)
        const totalFixedWeeklyCost = enabledCategories.filter(c => c.fixedWeeklyAmount > 0)
                                                     .reduce((sum, cat) => sum + cat.fixedWeeklyAmount, 0);

        // Calculate total percentage only for the *variable* categories (Groceries, Gas, Misc)
        const variableCategories = enabledCategories.filter(c => c.fixedWeeklyAmount === 0);
        // Ensure total is 100, assuming default percentages hold
        const totalVariablePercentage = variableCategories.reduce((sum, cat) => sum + cat.percentage, 0); 
        
        renderCategoryToggles(activeSpendingCategories); // Render toggles here

        planDefinitions.forEach(plan => {
            // Apply the plan margin to the base weekly budget, then subtract fixed costs
            const weeklyBudgetForVariable = (baseWeeklyBudget * plan.margin) - totalFixedWeeklyCost;
            
            // This is the total weekly amount this plan allocates (fixed + variable)
            const totalWeeklyAllocation = totalFixedWeeklyCost + (weeklyBudgetForVariable > 0 ? weeklyBudgetForVariable : 0);
            
            // Calculate breakdown for display and data
            const categoryBreakdown = enabledCategories.map(cat => {
                let amount;
                let isFixed = cat.fixedWeeklyAmount > 0;
                
                if (isFixed) {
                    amount = cat.fixedWeeklyAmount;
                } else {
                    // Only allocate from the variable budget if the variable budget is positive
                    if (weeklyBudgetForVariable > 0 && totalVariablePercentage > 0) {
                        // Allocate based on the category's relative percentage share of the total variable percentage
                        amount = (weeklyBudgetForVariable * (cat.percentage / totalVariablePercentage));
                    } else {
                        amount = 0;
                    }
                }
                
                // Enforce Gas maximum/minimum (only applies to variable allocation)
                if (cat.name === 'Gas/Fuel' && !isFixed) {
                    if (amount > 100) amount = 100;
                    if (amount < 30) amount = 30;
                }
                
                // Ensure no negative allocation
                amount = Math.max(0, amount); 
                
                return {
                    name: cat.name,
                    amount: amount
                };
            });
            
            const breakdownHtml = categoryBreakdown.filter(i => i.amount > 0.01).map(item => `
                <li class="flex justify-between text-sm text-gray-700">
                    <span>${item.name}:</span>
                    <span class="font-medium text-red-600">$${item.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                </li>
            `).join('');

            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200';
            card.innerHTML = `
                <h3 class="text-lg font-bold mb-3">${plan.name}</h3>
                <p class="text-sm text-gray-500">
                    Saves ${((1 - plan.margin) * 100).toFixed(0)}% of the **Remaining Budget** (after fixed savings goal).
                </p>
                <p class="text-lg font-semibold text-gray-900 mb-2 mt-2">
                    Total Weekly Plan: $${totalWeeklyAllocation.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </p>
                <ul class="list-disc list-inside space-y-1 ml-4 mb-4">
                    ${breakdownHtml || '<li class="text-gray-500 italic">No budget allocated to selected categories.</li>'}
                </ul>
                <button data-plan='${JSON.stringify({ breakdown: categoryBreakdown, name: plan.name })}' 
                        class="apply-plan-btn w-full py-2 text-white font-semibold rounded-lg ${plan.buttonClass}">
                    Select Plan & Generate Expenses
                </button>
            `;
            planButtonsEl.appendChild(card);
        });
    }

    function applySpendingPlan(planData) {
        if (!confirm(`Are you sure you want to apply the ${planData.name} and clear any existing planned weekly budgets?`)) {
            return;
        }

        // 1. Clear any existing planned entries
        oneTimeTransactions = oneTimeTransactions.filter(t => !t.name.includes('(Planned)'));
        
        const breakdown = planData.breakdown;
        const startDate = startDateEl.value;
        const projectionMonths = parseInt(projectionMonthsEl.value);
        
        const totalWeeks = calculateTotalWeeks(startDate, projectionMonths);
        let currentWeekStart = startOfISOWeek(parseISO(startDate));
        const limitDate = addMonths(parseISO(startDate), projectionMonths);
        let transactionCount = 0;

        // 2. Generate new planned one-time expenses for each week
        for (let i = 0; i < totalWeeks; i++) {
            const weekDate = addDays(currentWeekStart, 4); // Use Thursday as default date for weekly plans
            
            if (isBefore(weekDate, limitDate) || isSameDay(weekDate, limitDate)) {

                breakdown.forEach(cat => {
                    const amount = cat.amount;
                    
                    if (amount > 0.01) { // Only generate a transaction if the amount is significant
                        const finalAmount = -amount; // Expenses are negative
                        
                        oneTimeTransactions.push({
                            id: `PLAN-${Date.now()}-${i}-${cat.name}`,
                            name: `${cat.name} (Planned)`,
                            amount: finalAmount,
                            date: format(weekDate, 'yyyy-MM-dd'),
                            type: 'One-Time'
                        });
                        transactionCount++;
                    }
                });
            }
            currentWeekStart = addDays(currentWeekStart, 7);
        }

        showStatus(`Generated ${transactionCount} planned weekly expenses for the forecast!`, 'bg-blue-100 text-blue-700');
        
        // 3. Save and redraw everything
        saveAndRender();
    }


    // The main entry point is already called near the start of the DOMContentLoaded block:
    // showDashboard();
    
});
</script>
</body>
</html>
