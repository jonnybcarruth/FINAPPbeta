<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Finance Dashboard</title>
    <!-- CRUCIAL CONFIGURATION FOR FULL-SCREEN APP MODE ON IPHONE -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FinPlan">
    <!-- APP ICON CONFIGURATION (NEW) -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/047857/ffffff?text=%24%E2%9C%93">
    <!-- END FULL-SCREEN CONFIGURATION -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals with Green/Red/Blue Accents -->
    <!-- Application Structure Plan: Restructured into a five-view Single Page Application (SPA) for clean navigation: 1. Calendar (Home - includes Projection Controls) 2. Dashboard (Key Metrics + Charts) 3. Debt Management 4. Recurring Schedules 5. Transaction Log. Navigation is managed by JavaScript to toggle the visibility of containers, optimizing the user experience for focused task management. -->
    <!-- Visualization & Content Choices: 1. SPA Navigation: HTML list + JS view switching. 2. Charts: Line/Bar charts (Chart.js) in the Dashboard view. 3. Data Entry: Modals for Debt, Recurring, and One-Time transactions. 4. Calendar: HTML grid. All data persists via localStorage. NO SVG/Mermaid used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; color: #343a40; padding-top: 64px; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .modal { transition: opacity 0.25s ease; }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-inactive { opacity: 0; pointer-events: none; }
        .calendar-grid { grid-template-rows: auto repeat(6, minmax(0, 1fr)); }
        .calendar-day { min-height: 100px; }
        .toggle-checkbox:checked { right: 0; border-color: #48BB78; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48BB78; }
        .active-nav { border-b-2 border-blue-600 text-blue-600 font-semibold; }
    </style>
</head>
<body class="antialiased">
    
    <!-- STATUS MESSAGE BAR (NEW) -->
    <div id="status-message" class="fixed top-16 left-0 right-0 p-3 text-center text-sm font-medium transition duration-300 opacity-0 z-50"></div>
    
    <!-- NAVIGATION BAR -->
    <nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 flex justify-between items-center h-16">
            <h1 class="text-xl font-bold text-gray-800">FinPlan</h1>
            <div class="flex space-x-4">
                <button data-view="calendar" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition">Calendar</button>
                <button data-view="dashboard" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition">Dashboard</button>
                <button data-view="debt" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition">Debt Plans</button>
                <button data-view="schedules" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition">Recurring</button>
                <button data-view="log" class="nav-btn px-3 py-2 text-gray-600 hover:text-blue-600 transition">Log</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 sm:p-6 md:p-8">

        <main class="space-y-8 md:space-y-12">

            <!-- 1. CALENDAR VIEW (HOME VIEW) -->
            <div id="view-calendar" class="view-container space-y-8">
                
                <section id="projection-controls" class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Projection Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Projection Start Date</label>
                            <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="projectionMonths" class="block text-sm font-medium text-gray-700 mb-1">Projection Length (Months)</label>
                            <select id="projectionMonths" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12" selected>12 Months</option>
                                <option value="24">24 Months</option>
                            </select>
                        </div>
                        <div>
                            <label for="startingBalance" class="block text-sm font-medium text-gray-700 mb-1">Starting Balance ($)</label>
                            <input type="number" id="startingBalance" value="5000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </section>

                <section id="calendar-view" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">Transaction Calendar</h2>
                        <button id="add-one-time-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">Add One-Time Event</button>
                    </div>
                    <p class="text-center text-gray-500 mb-6 max-w-2xl mx-auto">This calendar displays all your financial events—recurring, one-time, and debt payments—for the selected month.</p>
                    <div id="calendar-controls" class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">&larr; Prev</button>
                        <h3 id="calendar-month-year" class="text-xl font-semibold"></h3>
                        <button id="next-month" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Next &rarr;</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 calendar-grid"></div>
                </section>
            </div>
            
            <!-- 2. DASHBOARD VIEW (CHARTS & METRICS) -->
            <div id="view-dashboard" class="view-container hidden space-y-8">
                <section id="key-metrics" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="text-md font-semibold text-gray-500">Projected End Balance</h3><p id="endBalance" class="text-3xl font-bold text-gray-800 mt-2">$0.00</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="text-md font-semibold text-gray-500">Total Income</h3><p id="totalIncome" class="text-3xl font-bold text-green-600 mt-2">$0.00</p></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="text-md font-semibold text-gray-500">Total Expenses</h3><p id="totalExpenses" class="text-3xl font-bold text-red-600 mt-2">$0.00</p></div>
                </section>
                
                <section id="visualizations" class="bg-white p-6 rounded-2xl shadow-sm space-y-12">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Cash Flow Projection</h2>
                        <p class="text-center text-gray-500 mb-4 max-w-2xl mx-auto">This chart shows the projected running balance over time, helping you anticipate future highs and lows.</p>
                        <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
                    </div>
                    <div>
                         <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Net Monthly Flow</h2>
                        <p class="text-center text-gray-500 mb-4 max-w-2xl mx-auto">This bar chart illustrates the net financial result for each month—the difference between total income and total expenses.</p>
                        <div class="chart-container"><canvas id="monthlyNetChart"></canvas></div>
                    </div>
                </section>
            </div>

            <!-- 3. DEBT MANAGEMENT VIEW -->
            <div id="view-debt" class="view-container hidden space-y-8">
                <section id="debt-plan-management" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Debt Plan Management</h2>
                        <button id="add-debt-plan-btn" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">Add New Debt Plan</button>
                    </div>
                    <p class="text-gray-500 mb-6">Define structured debt repayments here. Payments are calculated based on the payoff period and automatically removed from the forecast once completed.</p>
                    <div id="debtPlansList" class="space-y-4"></div>
                </section>
            </div>

            <!-- 4. RECURRING SCHEDULES VIEW -->
            <div id="view-schedules" class="view-container hidden space-y-8">
                <section id="schedules-management" class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Recurring Schedules Management</h2>
                        <button id="add-schedule-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Add New Recurring Schedule</button>
                    </div>
                    <p class="text-gray-500 mb-6">Manage all your **long-term, repeating** financial events here. Toggle items to run "what-if" scenarios.</p>
                    <div id="schedulesList" class="space-y-4"></div>
                </section>
            </div>

            <!-- 5. TRANSACTION LOG VIEW -->
            <div id="view-log" class="view-container hidden space-y-8">
                 <section id="transaction-log" class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Projected Transaction Log</h2>
                    <p class="text-gray-500 mb-6">A detailed, day-by-day list of all projected transactions (recurring, one-time, and debt payments). Filter by type for a granular analysis.</p>
                    <div class="mb-4">
                         <select id="transactionFilter" class="p-2 border border-gray-300 rounded-lg">
                             <option value="all">All Transactions</option><option value="income">Income Only</option><option value="expense">Expenses Only</option>
                         </select>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th></tr></thead><tbody id="transactionTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </section>
            </div>
            
        </main>
    </div>

    <!-- Modals (Global, accessible from all views) -->

    <!-- Modal for Recurring Schedules (Complex) -->
    <div id="schedule-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">Add New Schedule</h3>
            <form id="schedule-form">
                <input type="hidden" id="schedule-id">
                <div class="space-y-4">
                    <div><label for="name" class="block text-sm font-medium">Name</label><input type="text" id="name" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="amount" class="block text-sm font-medium">Amount (use "-" for expenses)</label><input type="number" step="0.01" id="amount" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="start_date" class="block text-sm font-medium">Start Date</label><input type="date" id="start_date" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="frequency" class="block text-sm font-medium">Frequency</label><select id="frequency" required class="w-full p-2 border rounded-lg"><option value="Monthly">Monthly</option><option value="Weekly">Weekly</option></select></div>
                    <div id="day-value-monthly"><label for="day_value_month" class="block text-sm font-medium">Day of Month (1-31)</label><input type="number" id="day_value_month" min="1" max="31" class="w-full p-2 border rounded-lg"></div>
                    <div id="day-value-weekly" class="hidden"><label for="day_value_week" class="block text-sm font-medium">Day of Week</label><select id="day_value_week" class="w-full p-2 border rounded-lg"><option>Sunday</option><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4"><button type="button" class="cancel-btn px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Schedule</button></div>
            </form>
        </div>
    </div>

    <!-- Modal for One-Time Transactions (Simple) -->
    <div id="onetime-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 class="text-2xl font-bold mb-6">Add One-Time Transaction</h3>
            <form id="onetime-form">
                <input type="hidden" id="onetime-id">
                <div class="space-y-4">
                    <div><label for="onetime-name" class="block text-sm font-medium">Name</label><input type="text" id="onetime-name" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="onetime-amount" class="block text-sm font-medium">Amount (use "-" for expense)</label><input type="number" step="0.01" id="onetime-amount" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="onetime-date" class="block text-sm font-medium">Date of Transaction</label><input type="date" id="onetime-date" required class="w-full p-2 border rounded-lg"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" class="cancel-btn px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Debt Plan -->
    <div id="debt-plan-modal" class="modal modal-inactive fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <h3 id="debt-modal-title" class="text-2xl font-bold mb-6">Add New Debt Plan</h3>
            <form id="debt-plan-form">
                <input type="hidden" id="debt-id">
                <div class="space-y-4">
                    <div><label for="debt-name" class="block text-sm font-medium">Debt Name</label><input type="text" id="debt-name" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="total-amount" class="block text-sm font-medium">Total Debt Amount ($)</label><input type="number" step="0.01" id="total-amount" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="payoff-months" class="block text-sm font-medium">Payoff Months (e.g., 12)</label><input type="number" id="payoff-months" min="1" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="debt-start-date" class="block text-sm font-medium">First Payment Date</label><input type="date" id="debt-start-date" required class="w-full p-2 border rounded-lg"></div>
                    <div><label for="debt-pay-day" class="block text-sm font-medium">Payment Day of Month (1-31)</label><input type="number" id="debt-pay-day" min="1" max="31" required class="w-full p-2 border rounded-lg"></div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" class="cancel-btn-debt px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700">Save Debt Plan</button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
import { addMonths, eachDayOfInterval, format, getDay, getDate, endOfMonth, startOfMonth, startOfWeek, endOfWeek, addDays, isSameMonth, isToday, subMonths, parseISO } from 'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/esm/index.js';

document.addEventListener('DOMContentLoaded', () => {

    let recurringSchedules = [];
    let oneTimeTransactions = [];
    let debtPlans = []; 
    let currentCalendarDate = new Date();
    let activeView = 'calendar'; 

    const defaultSchedules = [
        { id: 'RENT-01', name: 'Monthly Rent Payment', amount: -1010.00, startDate: '2024-01-03', frequency: 'Monthly', dayValue: 3, enabled: true },
        { id: 'SALARY-01', name: 'Weekly Salary', amount: 1000.00, startDate: '2024-01-04', frequency: 'Weekly', dayValue: 'Thursday', enabled: true },
    ];
    
    const weeklyDayMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };

    const startDateEl = document.getElementById('startDate');
    const projectionMonthsEl = document.getElementById('projectionMonths');
    const startingBalanceEl = document.getElementById('startingBalance');
    const schedulesListEl = document.getElementById('schedulesList');
    const debtPlansListEl = document.getElementById('debtPlansList');
    const transactionFilterEl = document.getElementById('transactionFilter');
    const statusMessageEl = document.getElementById('status-message'); 

    // Modals
    const scheduleModal = document.getElementById('schedule-modal');
    const oneTimeModal = document.getElementById('onetime-modal');
    const debtPlanModal = document.getElementById('debt-plan-modal'); 

    // Forms
    const scheduleForm = document.getElementById('schedule-form');
    const oneTimeForm = document.getElementById('onetime-form');
    const debtPlanForm = document.getElementById('debt-plan-form'); 

    // Form Inputs
    const scheduleIdInput = document.getElementById('schedule-id');
    const frequencySelect = document.getElementById('frequency');
    const debtIdInput = document.getElementById('debt-id'); 
    
    const navButtons = document.querySelectorAll('.nav-btn');
    const viewContainers = document.querySelectorAll('.view-container');

    let cashFlowChart, monthlyNetChart;

    function initialize() {
        startDateEl.value = format(new Date(), 'yyyy-MM-dd');
        loadData();
        renderSchedules();
        renderDebtPlans(); 
        addEventListeners();
        changeView(activeView); 
        updateDashboard();
    }
    
    // Displays a temporary status message
    function showStatus(message, colorClass) {
        if (statusMessageEl) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `fixed top-16 left-0 right-0 p-3 text-center text-sm font-medium transition duration-300 ${colorClass}`;
            statusMessageEl.classList.remove('opacity-0');
            statusMessageEl.classList.add('opacity-100');
            setTimeout(() => {
                statusMessageEl.classList.remove('opacity-100');
                statusMessageEl.classList.add('opacity-0');
            }, 5000);
        }
    }

    // --- VIEW MANAGEMENT LOGIC ---
    function changeView(viewId) {
        activeView = viewId;
        viewContainers.forEach(container => {
            container.classList.add('hidden');
        });
        document.getElementById(`view-${viewId}`).classList.remove('hidden');

        navButtons.forEach(btn => {
            btn.classList.remove('active-nav');
            if (btn.dataset.view === viewId) {
                btn.classList.add('active-nav');
            }
        });
        
        // Ensure charts are redrawn if switching to dashboard
        if (viewId === 'dashboard') {
             // Delay to ensure the container is fully visible before Chart.js renders
            setTimeout(() => {
                updateCashFlowChart(generateProjections());
                updateMonthlyNetChart(generateProjections());
            }, 10); 
        }
    }
    // --- END VIEW MANAGEMENT LOGIC ---

    // UPDATED FUNCTION with try...catch and status message
    function loadData() {
        try {
            const savedSchedules = localStorage.getItem('recurringSchedules');
            const savedOneTime = localStorage.getItem('oneTimeTransactions');
            const savedDebtPlans = localStorage.getItem('debtPlans'); 

            if (savedSchedules && savedOneTime && savedDebtPlans) {
                recurringSchedules = JSON.parse(savedSchedules);
                oneTimeTransactions = JSON.parse(savedOneTime);
                debtPlans = JSON.parse(savedDebtPlans);
                showStatus('Projection data loaded successfully.', 'bg-green-100 text-green-700');
            } else {
                recurringSchedules = defaultSchedules;
                showStatus('Starting fresh or no saved data found.', 'bg-yellow-100 text-yellow-700');
            }
        } catch (e) {
            console.error("Error loading data from localStorage:", e);
            recurringSchedules = defaultSchedules;
            showStatus('ERROR: Could not load data! Check browser settings.', 'bg-red-100 text-red-700');
        }
    }

    // UPDATED FUNCTION with try...catch and status message
    function saveData() {
        try {
            localStorage.setItem('recurringSchedules', JSON.stringify(recurringSchedules));
            localStorage.setItem('oneTimeTransactions', JSON.stringify(oneTimeTransactions));
            localStorage.setItem('debtPlans', JSON.stringify(debtPlans)); 
            showStatus('Data saved successfully!', 'bg-blue-100 text-blue-700');
        } catch (e) {
            console.error("Error saving data to localStorage:", e);
            showStatus('ERROR: Could not save data. Check browser settings (incognito mode/permissions).', 'bg-red-100 text-red-700');
        }
    }
    
    function saveAndRender() {
        saveData();
        renderSchedules();
        renderDebtPlans(); 
        updateDashboard();
    }
    
    function renderDebtPlans() {
        debtPlansListEl.innerHTML = '';
        debtPlans.forEach(plan => {
            const monthly = (plan.totalAmount / plan.payoffMonths).toFixed(2);
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 rounded-xl border border-pink-200 bg-white shadow-sm hover:shadow-md transition';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mr-4 bg-pink-500"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${plan.name}</p>
                        <p class="text-sm text-gray-500">Total: $${plan.totalAmount.toLocaleString()} | Payoff: ${plan.payoffMonths} months</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p class="font-bold text-lg text-pink-600 w-24 text-right">
                        $${monthly}
                    </p>
                    <div class="flex space-x-1">
                        <button type="button" class="debt-edit-btn p-2 text-gray-500 hover:text-pink-600 rounded-full hover:bg-gray-100" data-id="${plan.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="debt-delete-btn p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100" data-id="${plan.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            debtPlansListEl.appendChild(item);
        });
    }

    function renderSchedules() {
        schedulesListEl.innerHTML = '';
        recurringSchedules.forEach(schedule => {
            const isExpense = schedule.amount < 0;
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 rounded-xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mr-4 ${isExpense ? 'bg-red-500' : 'bg-green-500'}"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${schedule.name}</p>
                        <p class="text-sm text-gray-500">${isExpense ? 'Expense' : 'Income'}: ${schedule.frequency}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p class="font-semibold text-lg ${isExpense ? 'text-red-600' : 'text-green-600'} w-24 text-right">
                        $${Math.abs(schedule.amount).toFixed(2)}
                    </p>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" name="toggle" id="toggle-${schedule.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${schedule.enabled ? 'checked' : ''} data-id="${schedule.id}"/>
                        <label for="toggle-${schedule.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <div class="flex space-x-1">
                        <button type="button" class="edit-btn p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100" data-id="${schedule.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z"></path></svg>
                        </button>
                        <button type="button" class="delete-btn p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100" data-id="${schedule.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            schedulesListEl.appendChild(item);
        });
    }

    function addEventListeners() {
        // Navigation Listener
        navButtons.forEach(btn => btn.addEventListener('click', (e) => {
            changeView(e.currentTarget.dataset.view);
        }));

        [startDateEl, projectionMonthsEl, startingBalanceEl, transactionFilterEl].forEach(el => el.addEventListener('change', updateDashboard));
        
        // --- DEBT PLAN EVENT LISTENERS ---
        debtPlansListEl.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.debt-edit-btn');
            const deleteBtn = e.target.closest('.debt-delete-btn');

            if (editBtn) {
                openDebtPlanModal(debtPlans.find(p => p.id === editBtn.dataset.id));
            } else if (deleteBtn) {
                if(confirm('Are you sure you want to delete this debt plan?')) {
                    debtPlans = debtPlans.filter(p => p.id !== deleteBtn.dataset.id);
                    saveAndRender();
                }
            }
        });

        document.getElementById('add-debt-plan-btn').addEventListener('click', () => openDebtPlanModal());
        document.querySelector('.cancel-btn-debt').addEventListener('click', () => closeModal(debtPlanModal));

        debtPlanForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = debtIdInput.value;
            const totalAmount = parseFloat(document.getElementById('total-amount').value);
            const payoffMonths = parseInt(document.getElementById('payoff-months').value);
            
            const newDebtPlan = {
                id: id || `DEBT-${Date.now()}`,
                name: document.getElementById('debt-name').value,
                totalAmount: totalAmount,
                payoffMonths: payoffMonths,
                monthlyPayment: parseFloat((totalAmount / payoffMonths).toFixed(2)),
                payDay: parseInt(format(parseISO(document.getElementById('debt-start-date').value), 'd')),
                startDate: document.getElementById('debt-start-date').value,
                enabled: true
            };

            if (id) {
                const index = debtPlans.findIndex(p => p.id === id);
                debtPlans[index] = newDebtPlan;
            } else {
                debtPlans.push(newDebtPlan);
            }
            closeModal(debtPlanModal);
            saveAndRender();
        });
        // --- END DEBT PLAN EVENT LISTENERS ---

        // Recurring Schedule Event Listeners
        schedulesListEl.addEventListener('click', (e) => {
            const toggle = e.target.closest('.toggle-checkbox');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (toggle) {
                const schedule = recurringSchedules.find(s => s.id === toggle.dataset.id);
                if (schedule) {
                    schedule.enabled = toggle.checked;
                    saveAndRender();
                }
            } else if (editBtn) {
                openRecurringModal(recurringSchedules.find(s => s.id === editBtn.dataset.id));
            } else if (deleteBtn) {
                if(confirm('Are you sure you want to delete this recurring schedule?')) {
                    recurringSchedules = recurringSchedules.filter(s => s.id !== deleteBtn.dataset.id);
                    saveAndRender();
                }
            }
        });

        document.getElementById('add-schedule-btn').addEventListener('click', () => openRecurringModal());
        document.getElementById('add-one-time-btn').addEventListener('click', () => openOneTimeModal());
        
        // Cancel buttons for all modals
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => {
            closeModal(scheduleModal);
            closeModal(oneTimeModal);
        }));

        // Modal close on backdrop click
        scheduleModal.addEventListener('click', (e) => { if (e.target === scheduleModal) closeModal(scheduleModal); });
        oneTimeModal.addEventListener('click', (e) => { if (e.target === oneTimeModal) closeModal(oneTimeModal); });
        debtPlanModal.addEventListener('click', (e) => { if (e.target === debtPlanModal) closeModal(debtPlanModal); }); 

        // Submit Recurring Schedule
        scheduleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = scheduleIdInput.value;
            const newSchedule = {
                id: id || `SCH-${Date.now()}`,
                name: document.getElementById('name').value,
                amount: parseFloat(document.getElementById('amount').value),
                startDate: document.getElementById('start_date').value,
                frequency: frequencySelect.value,
                dayValue: frequencySelect.value === 'Monthly' ? parseInt(document.getElementById('day_value_month').value) : document.getElementById('day_value_week').value,
                enabled: true
            };

            if (id) {
                const index = recurringSchedules.findIndex(s => s.id === id);
                newSchedule.enabled = recurringSchedules[index].enabled;
                recurringSchedules[index] = newSchedule;
            } else {
                recurringSchedules.push(newSchedule);
            }
            closeModal(scheduleModal);
            saveAndRender();
        });

        // Submit One-Time Transaction
        oneTimeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newTransaction = {
                id: `ONE-${Date.now()}`,
                name: document.getElementById('onetime-name').value,
                amount: parseFloat(document.getElementById('onetime-amount').value),
                date: document.getElementById('onetime-date').value,
            };
            oneTimeTransactions.push(newTransaction);
            closeModal(oneTimeModal);
            saveAndRender();
        });

        frequencySelect.addEventListener('change', toggleDayValueInputs);

        document.getElementById('prev-month').addEventListener('click', () => {
            currentCalendarDate = subMonths(currentCalendarDate, 1);
            updateDashboard(); // FIXED: Calls updateDashboard to regenerate projections and redraw the calendar safely.
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentCalendarDate = addMonths(currentCalendarDate, 1);
            updateDashboard(); // FIXED: Calls updateDashboard to regenerate projections and redraw the calendar safely.
        });
    }
    
    function openDebtPlanModal(plan = null) {
        debtPlanForm.reset();
        document.getElementById('debt-pay-day').value = 1; 
        if (plan) {
            document.getElementById('debt-modal-title').textContent = 'Edit Debt Plan';
            debtIdInput.value = plan.id;
            document.getElementById('debt-name').value = plan.name;
            document.getElementById('total-amount').value = plan.totalAmount;
            document.getElementById('payoff-months').value = plan.payoffMonths;
            document.getElementById('debt-start-date').value = plan.startDate;
            document.getElementById('debt-pay-day').value = plan.payDay;
        } else {
            document.getElementById('debt-modal-title').textContent = 'Add New Debt Plan';
            debtIdInput.value = '';
            document.getElementById('debt-start-date').value = format(new Date(), 'yyyy-MM-dd');
        }
        debtPlanModal.classList.remove('modal-inactive');
        debtPlanModal.classList.add('modal-active');
    }
    
    function openRecurringModal(schedule = null) {
        scheduleForm.reset();
        if (schedule) {
            document.getElementById('modal-title').textContent = 'Edit Recurring Schedule';
            scheduleIdInput.value = schedule.id;
            document.getElementById('name').value = schedule.name;
            document.getElementById('amount').value = schedule.amount;
            document.getElementById('start_date').value = schedule.startDate;
            frequencySelect.value = schedule.frequency;
            if (schedule.frequency === 'Monthly') {
                document.getElementById('day_value_month').value = schedule.dayValue;
            } else {
                document.getElementById('day_value_week').value = schedule.dayValue;
            }
        } else {
            document.getElementById('modal-title').textContent = 'Add New Recurring Schedule';
            scheduleIdInput.value = '';
        }
        toggleDayValueInputs();
        scheduleModal.classList.remove('modal-inactive');
        scheduleModal.classList.add('modal-active');
    }

    function openOneTimeModal() {
        oneTimeForm.reset();
        document.getElementById('onetime-date').value = format(currentCalendarDate, 'yyyy-MM-dd');
        oneTimeModal.classList.remove('modal-inactive');
        oneTimeModal.classList.add('modal-active');
    }

    function closeModal(el) {
        el.classList.add('modal-inactive');
        el.classList.remove('modal-active');
    }

    function toggleDayValueInputs() {
        if (frequencySelect.value === 'Monthly') {
            document.getElementById('day-value-monthly').classList.remove('hidden');
            document.getElementById('day-value-weekly').classList.add('hidden');
            document.getElementById('day_value_month').required = true;
            document.getElementById('day_value_week').required = false;
        } else {
            document.getElementById('day-value-monthly').classList.add('hidden');
            document.getElementById('day-value-weekly').classList.remove('hidden');
            document.getElementById('day_value_month').required = false;
            document.getElementById('day_value_week').required = true;
        }
    }

    function generateProjections() {
        const startDate = new Date(startDateEl.value + 'T00:00:00');
        const months = parseInt(projectionMonthsEl.value);
        const endDate = addMonths(startDate, months);
        const activeSchedules = recurringSchedules.filter(s => s.enabled);
        let projections = [];
        
        // 1. Generate Recurring Projections
        const intervalDays = eachDayOfInterval({ start: startDate, end: endDate });
        intervalDays.forEach(day => {
            activeSchedules.forEach(schedule => {
                if (day < new Date(schedule.startDate + 'T00:00:00')) return;
                if (schedule.frequency === 'Monthly' && getDate(day) === schedule.dayValue) {
                    projections.push({ date: day, name: schedule.name, amount: schedule.amount, type: 'Recurring' });
                } else if (schedule.frequency === 'Weekly' && getDay(day) === weeklyDayMap[schedule.dayValue]) {
                    projections.push({ date: day, name: schedule.name, amount: schedule.amount, type: 'Recurring' });
                }
            });
        });

        // 2. Add Debt Plan Payments
        debtPlans.forEach(plan => { 
            let paymentsMade = 0;
            
            let currentMonth = startOfMonth(startDate);
            while (currentMonth <= endDate && paymentsMade < plan.payoffMonths) {
                const day = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), plan.payDay);

                if (day >= startDate && day <= endDate && day >= parseISO(plan.startDate)) {
                    projections.push({ 
                        date: day, 
                        name: `Debt Payment: ${plan.name}`, 
                        amount: -plan.monthlyPayment, 
                        type: 'Debt Payment' 
                    });
                    paymentsMade++;
                }
                currentMonth = addMonths(currentMonth, 1);
            }
        });


        // 3. Add One-Time Transactions
        oneTimeTransactions.forEach(t => {
            const tDate = new Date(t.date + 'T00:00:00');
            if (tDate >= startDate && tDate <= endDate) {
                projections.push({ date: tDate, name: t.name, amount: t.amount, type: 'One-Time' });
            }
        });

        return projections.sort((a, b) => a.date - b.date);
    }
    
    function updateDashboard() {
        const projections = generateProjections();
        updateKeyMetrics(projections);
        // Only call chart updates if the dashboard view is active or immediately after controls change
        if (activeView === 'dashboard') {
            updateCashFlowChart(projections);
            updateMonthlyNetChart(projections);
        }
        renderCalendar(projections);
        renderTransactionTable(projections);
    }

    function renderCalendar(projections) {
        const calendarGrid = document.getElementById('calendar-grid');
        document.getElementById('calendar-month-year').textContent = format(currentCalendarDate, 'MMMM yyyy');
        calendarGrid.innerHTML = '';
        const monthStart = startOfMonth(currentCalendarDate);
        const monthEnd = endOfMonth(currentCalendarDate);
        const startDate = startOfWeek(monthStart);
        const endDate = endOfWeek(monthEnd);
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        // Render Day Headers
        days.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = "text-center font-semibold text-sm text-gray-600 py-2";
            dayEl.textContent = day;
            calendarGrid.appendChild(dayEl);
        });
        
        let day = startDate;
        while(day <= endDate) {
            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day p-2 border border-gray-200 rounded-md ${!isSameMonth(day, monthStart) ? 'bg-gray-50 text-gray-400' : 'bg-white'}`;
            if (isToday(day)) { dayEl.classList.add('border-blue-500', 'border-2'); }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = "text-sm font-semibold";
            dayNumber.textContent = format(day, 'd');
            dayEl.appendChild(dayNumber);

            const dailyTransactions = projections.filter(p => format(p.date, 'yyyy-MM-dd') === format(day, 'yyyy-MM-dd'));
            const transactionList = document.createElement('ul');
            transactionList.className = 'mt-1 space-y-1 text-xs overflow-y-auto'
            dailyTransactions.forEach(t => {
                let colorClass;
                let borderClass = '';
                if (t.type === 'Debt Payment') {
                    colorClass = 'bg-pink-100 text-pink-800';
                    borderClass = 'border-l-2 border-pink-500';
                } else if (t.type === 'One-Time') {
                    colorClass = (t.amount > 0 ? 'bg-purple-100 text-purple-800' : 'bg-red-100 text-red-800');
                    borderClass = 'border-l-2 border-purple-500';
                } else if (t.amount > 0) {
                    colorClass = 'bg-green-100 text-green-800';
                } else {
                    colorClass = 'bg-red-100 text-red-800';
                }
                
                const li = document.createElement('li');
                li.className = `flex items-center p-1 rounded ${colorClass} ${borderClass}`;
                li.innerHTML = `<span class="truncate" title="${t.name}">${t.name}</span> <span class="font-semibold ml-auto">$${Math.abs(t.amount).toFixed(0)}</span>`;
                transactionList.appendChild(li);
            });
            dayEl.appendChild(transactionList);
            calendarGrid.appendChild(dayEl);
            day = addDays(day, 1);
        }
    }

    function updateKeyMetrics(projections) {
        const startingBalance = parseFloat(startingBalanceEl.value);
        let totalIncome = 0;
        let totalExpenses = 0;
        projections.forEach(p => {
            if (p.amount > 0) totalIncome += p.amount;
            else totalExpenses += p.amount;
        });
        const endBalance = startingBalance + totalIncome + totalExpenses;

        document.getElementById('endBalance').textContent = `$${endBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalExpenses').textContent = `$${Math.abs(totalExpenses).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        return { totalIncome, totalExpenses, endBalance };
    }

    function renderTransactionTable(projections) {
        const tableBody = document.getElementById('transactionTableBody');
        tableBody.innerHTML = '';
        const filter = transactionFilterEl.value;
        const filtered = projections.filter(p => {
            if (filter === 'all') return true;
            if (filter === 'income') return p.amount > 0;
            // Treat debt payments and normal expenses as 'expense' for this filter
            if (filter === 'expense') return p.amount < 0; 
        });

        if (filtered.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500">No transactions for this period.</td></tr>`;
            return;
        }

        filtered.forEach(p => {
            const row = tableBody.insertRow();
            let typeLabel;
            let amountClass;
            
            if (p.type === 'Debt Payment') {
                typeLabel = 'Debt';
                amountClass = 'text-pink-600';
            } else if (p.type === 'One-Time') {
                typeLabel = 'One-Time';
                amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
            } else {
                typeLabel = 'Recurring';
                amountClass = p.amount > 0 ? 'text-green-600' : 'text-red-600';
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${format(p.date, 'MMM dd, yyyy')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${p.name} <span class="text-xs text-gray-400">(${typeLabel})</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${amountClass}">${p.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
            `;
        });
    }

    function updateCashFlowChart(projections) {
        const ctx = document.getElementById('cashFlowChart').getContext('2d');
        const startingBalance = parseFloat(startingBalanceEl.value);
        let currentBalance = startingBalance;
        
        const dataPoints = [{ x: new Date(startDateEl.value + 'T00:00:00'), y: startingBalance }];
        projections.forEach(p => {
            currentBalance += p.amount;
            dataPoints.push({ x: p.date, y: currentBalance });
        });

        if (cashFlowChart) cashFlowChart.destroy();
        cashFlowChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Projected Balance',
                    data: dataPoints,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'month' } },
                    y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } }
                },
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: (context) => ` Balance: ${context.formattedValue}`
                        }
                    }
                }
            }
        });
    }
    
    function updateMonthlyNetChart(projections) {
        const ctx = document.getElementById('monthlyNetChart').getContext('2d');
        const monthlyData = {};
        projections.forEach(p => {
            const month = format(p.date, 'yyyy-MM');
            if (!monthlyData[month]) monthlyData[month] = 0;
            monthlyData[month] += p.amount;
        });

        const labels = Object.keys(monthlyData).sort();
        const data = labels.map(label => monthlyData[label]);

        if (monthlyNetChart) monthlyNetChart.destroy();
        monthlyNetChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => format(new Date(l + '-02T00:00:00'), 'MMM yyyy')),
                datasets: [{
                    label: 'Net Monthly Flow',
                    data: data,
                    backgroundColor: data.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.7)' : 'rgba(220, 38, 38, 0.7)'),
                    borderColor: data.map(v => v >= 0 ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } } }
            }
        });
    }

    initialize();
});
</script>
</body>
</html>
